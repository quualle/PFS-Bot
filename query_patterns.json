{
  "common_queries": {
    "get_active_care_stays_now": {
      "description": "Ruft alle AKTUELL laufenden Care Stays ab, die den heutigen Tag umfassen (aktive Betreuungen)",
      "required_parameters": ["seller_id"],
      "optional_parameters": ["limit"],
      "sql_template": "SELECT cs._id AS cs_id, cs.bill_start, cs.bill_end, cs.stage, cs.prov_seller, lead_names.first_name, lead_names.last_name, agencies.name AS agency_name, DATE_DIFF(DATE(TIMESTAMP(cs.bill_end)), DATE(TIMESTAMP(cs.bill_start)), DAY) AS care_stay_duration_days FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS cs JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` AS c ON cs.contract_id = c._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.households` AS h ON c.household_id = h._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.leads` AS l ON h.lead_id = l._id LEFT JOIN `gcpxbixpflegehilfesenioren.dataform_staging.leads_and_seller_and_source_with_address` AS lead_names ON l._id = lead_names._id LEFT JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.agencies` AS agencies ON c.agency_id = agencies._id WHERE l.seller_id = @seller_id AND cs.stage = 'Bestätigt' AND DATE(TIMESTAMP(cs.bill_start)) <= CURRENT_DATE() AND DATE(TIMESTAMP(cs.bill_end)) >= CURRENT_DATE() ORDER BY cs.bill_start DESC LIMIT @limit",
      "default_values": {
        "limit": 1000
      },
      "result_structure": {
        "cs_id": "ID des Care Stays",
        "bill_start": "Startdatum der Abrechnung",
        "bill_end": "Enddatum der Abrechnung",
        "stage": "Status des Care Stays",
        "prov_seller": "Provision für den Verkäufer",
        "first_name": "Vorname des Kunden",
        "last_name": "Nachname des Kunden",
        "agency_name": "Name der Agentur",
        "care_stay_duration_days": "Dauer des Care Stays in Tagen"
      }
    },

    "get_care_stays_by_date_range": {
      "description": "HAUPTFUNKTION FÜR ZEITRAUMBEZOGENE ABFRAGEN. Ruft Care Stays in einem bestimmten Zeitraum ab, mit flexibler Zeitfilterung.",
      "required_parameters": ["seller_id", "start_date", "end_date"],
      "optional_parameters": ["limit", "filter_type"],
      "sql_template": "SELECT cs._id AS cs_id, cs.bill_start, cs.bill_end, cs.stage, cs.prov_seller, lead_names.first_name, lead_names.last_name, agencies.name AS agency_name, DATE_DIFF(DATE(TIMESTAMP(cs.bill_end)), DATE(TIMESTAMP(cs.bill_start)), DAY) AS care_stay_duration_days FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS cs JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` AS c ON cs.contract_id = c._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.households` AS h ON c.household_id = h._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.leads` AS l ON h.lead_id = l._id LEFT JOIN `gcpxbixpflegehilfesenioren.dataform_staging.leads_and_seller_and_source_with_address` AS lead_names ON l._id = lead_names._id LEFT JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.agencies` AS agencies ON c.agency_id = agencies._id WHERE l.seller_id = @seller_id AND cs.stage = 'Bestätigt' AND CASE WHEN @filter_type = 'start' THEN DATE(TIMESTAMP(cs.bill_start)) BETWEEN @start_date AND @end_date WHEN @filter_type = 'end' THEN DATE(TIMESTAMP(cs.bill_end)) BETWEEN @start_date AND @end_date WHEN @filter_type = 'active' THEN DATE(TIMESTAMP(cs.bill_start)) <= @end_date AND DATE(TIMESTAMP(cs.bill_end)) >= @start_date ELSE DATE(TIMESTAMP(cs.bill_start)) BETWEEN @start_date AND @end_date END ORDER BY cs.bill_start DESC LIMIT @limit",
      "default_values": {
        "limit": 1000,
        "filter_type": "active"
      },
      "parameter_types": {
        "limit": "int",
        "filter_type": "string"
      },
      "result_structure": {
        "cs_id": "ID des Care Stays",
        "bill_start": "Startdatum der Abrechnung",
        "bill_end": "Enddatum der Abrechnung",
        "stage": "Status des Care Stays",
        "prov_seller": "Provision für den Verkäufer",
        "first_name": "Vorname des Kunden",
        "last_name": "Nachname des Kunden",
        "agency_name": "Name der Agentur",
        "care_stay_duration_days": "Dauer des Care Stays in Tagen"
      }
    },

    "get_contract_terminations": {
      "description": "Ruft beendete Verträge ab, mit detaillierter Unterscheidung zwischen ernsthaften Kündigungen, nicht-ernsthaften Kündigungen und Agenturwechseln",
      "required_parameters": ["seller_id", "start_date", "end_date"],
      "optional_parameters": ["limit"],
      "sql_template": "WITH terminated_contracts AS (SELECT c._id AS contract_id, c.termination_reason, c.created_at, c.updated_at, c.household_id, lead_names.first_name, lead_names.last_name, agencies.name AS agency_name, MAX(CASE WHEN cs.stage = 'Bestätigt' THEN cs.departure ELSE NULL END) AS last_departure_date, COUNT(CASE WHEN cs.stage = 'Bestätigt' THEN cs._id ELSE NULL END) AS care_stay_count, MIN(CASE WHEN cs.stage = 'Bestätigt' THEN cs.arrival ELSE NULL END) AS first_arrival_date, CASE WHEN NOT EXISTS (SELECT 1 FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS confirmed_cs WHERE confirmed_cs.contract_id = c._id AND confirmed_cs.stage = 'Bestätigt') AND EXISTS (SELECT 1 FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS aborted_cs WHERE aborted_cs.contract_id = c._id AND aborted_cs.stage = 'Abgebrochen') THEN 'Nicht ernsthaft' WHEN EXISTS (SELECT 1 FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` AS other_c JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS other_cs ON other_c._id = other_cs.contract_id AND other_cs.stage = 'Bestätigt' WHERE other_c.household_id = c.household_id AND other_c._id != c._id AND other_c.created_at > c.created_at) AND EXISTS (SELECT 1 FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS confirmed_cs WHERE confirmed_cs.contract_id = c._id AND confirmed_cs.stage = 'Bestätigt') THEN 'Agenturwechsel' ELSE 'Ernsthaft' END AS termination_type FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` AS c JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.households` AS h ON c.household_id = h._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.leads` AS l ON h.lead_id = l._id LEFT JOIN `gcpxbixpflegehilfesenioren.dataform_staging.leads_and_seller_and_source_with_address` AS lead_names ON l._id = lead_names._id LEFT JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.agencies` AS agencies ON c.agency_id = agencies._id LEFT JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS cs ON c._id = cs.contract_id WHERE l.seller_id = @seller_id AND c.archived = 'true' GROUP BY c._id, c.termination_reason, c.created_at, c.updated_at, c.household_id, lead_names.first_name, lead_names.last_name, agencies.name), filtered_contracts AS (SELECT * FROM terminated_contracts WHERE last_departure_date IS NOT NULL AND SUBSTR(last_departure_date, 1, 10) >= @start_date AND SUBSTR(last_departure_date, 1, 10) <= @end_date) SELECT contract_id, first_name, last_name, agency_name, termination_reason, termination_type, last_departure_date, first_arrival_date, created_at, updated_at, (SELECT COUNT(*) FROM filtered_contracts WHERE termination_type = 'Ernsthaft') AS serious_terminations_count, (SELECT COUNT(*) FROM filtered_contracts WHERE termination_type = 'Agenturwechsel') AS agency_switch_count, (SELECT COUNT(*) FROM filtered_contracts) AS total_terminations_count FROM filtered_contracts ORDER BY last_departure_date DESC LIMIT @limit",
      "default_values": {
        "limit": 500,
        "start_date": "DATE_SUB(CURRENT_DATE(), INTERVAL 90 DAY)",
        "end_date": "CURRENT_DATE()"
      },
      "parameter_types": {
        "limit": "int",
        "start_date": "date",
        "end_date": "date"
      },
      "use_cases": [
        "Wenn nach Kündigungen in einem bestimmten Zeitraum gefragt wird - WICHTIG: immer die Aufschlüsselung ernsthaft vs. Agenturwechsel dazugeben",
        "Wenn eine Aufschlüsselung nach Kündigungsarten (ernsthaft vs. Agenturwechsel) benötigt wird",
        "Wenn Trends bei Vertragsbeendigungen analysiert werden sollen"
      ],
      "avoid_when": [
        "Nur nach aktuellen Verträgen gefragt wird",
        "Nur nach allgemeinen Kundendaten ohne Bezug zu Kündigungen gefragt wird"
      ],
      "result_structure": {
        "contract_id": "ID des Vertrags",
        "first_name": "Vorname des Kunden",
        "last_name": "Nachname des Kunden",
        "agency_name": "Name der Agentur",
        "termination_reason": "Grund für die Kündigung",
        "termination_type": "Art der Kündigung (Ernsthaft/Nicht ernsthaft/Agenturwechsel)",
        "last_departure_date": "Datum der letzten Abreise einer Pflegekraft",
        "first_arrival_date": "Datum der ersten Ankunft einer Pflegekraft",
        "created_at": "Erstellungsdatum des Vertrags",
        "updated_at": "Datum der letzten Aktualisierung des Vertrags",
        "serious_terminations_count": "Anzahl ernsthafter Kündigungen (tatsächlicher Kundenverlust)",
        "agency_switch_count": "Anzahl Agenturwechsel (Kunde wechselte zu anderer Agentur)",
        "total_terminations_count": "Gesamtanzahl der Kündigungen"
      }
    },

    "get_customers_on_pause": {
      "description": "Ruft Kunden ab, die sich in einer Betreuungspause befinden (aktiver Vertrag, aber aktuell kein laufender Pflegeeinsatz)",
      "required_parameters": ["seller_id"],
      "optional_parameters": ["limit"],
      "sql_template": "WITH active_contracts AS (SELECT c._id AS contract_id, c.created_at, h.lead_id, lead_names.first_name, lead_names.last_name, agencies.name AS agency_name FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` AS c JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.households` AS h ON c.household_id = h._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.leads` AS l ON h.lead_id = l._id LEFT JOIN `gcpxbixpflegehilfesenioren.dataform_staging.leads_and_seller_and_source_with_address` AS lead_names ON l._id = lead_names._id LEFT JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.agencies` AS agencies ON c.agency_id = agencies._id WHERE l.seller_id = @seller_id AND c.archived = 'false'), has_previous_care_stays AS (SELECT c.contract_id, MAX(cs.departure) AS last_departure FROM active_contracts c JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` cs ON c.contract_id = cs.contract_id WHERE cs.stage = 'Bestätigt' AND DATE(TIMESTAMP(cs.arrival)) < CURRENT_DATE() GROUP BY c.contract_id), current_care_stays AS (SELECT c.contract_id FROM active_contracts c JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` cs ON c.contract_id = cs.contract_id WHERE cs.stage = 'Bestätigt' AND DATE(TIMESTAMP(cs.arrival)) <= CURRENT_DATE() AND DATE(TIMESTAMP(cs.departure)) >= CURRENT_DATE()), next_care_stays AS (SELECT contract_id, next_arrival, next_stage FROM (SELECT c.contract_id, cs.arrival AS next_arrival, cs.stage AS next_stage, ROW_NUMBER() OVER (PARTITION BY c.contract_id ORDER BY cs.arrival) AS rn FROM active_contracts c JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` cs ON c.contract_id = cs.contract_id WHERE DATE(TIMESTAMP(cs.arrival)) > CURRENT_DATE()) WHERE rn = 1) SELECT ac.contract_id, ac.first_name, ac.last_name, ac.agency_name, hpcs.last_departure, DATE_DIFF(CURRENT_DATE(), DATE(TIMESTAMP(hpcs.last_departure)), DAY) AS days_on_pause, ncs.next_arrival AS naechster_carestay, ncs.next_stage AS status_naechster_carestay, (SELECT COUNT(*) FROM has_previous_care_stays hpcs2 WHERE hpcs2.contract_id NOT IN (SELECT contract_id FROM current_care_stays) AND hpcs2.last_departure IS NOT NULL) AS total_paused_customers FROM active_contracts ac JOIN has_previous_care_stays hpcs ON ac.contract_id = hpcs.contract_id LEFT JOIN next_care_stays ncs ON ac.contract_id = ncs.contract_id WHERE ac.contract_id NOT IN (SELECT contract_id FROM current_care_stays) AND hpcs.last_departure IS NOT NULL ORDER BY days_on_pause DESC LIMIT 10000",
      "default_values": {
        "limit": 500
      },
      "result_structure": {
        "contract_id": "ID des Vertrags",
        "first_name": "Vorname des Kunden",
        "last_name": "Nachname des Kunden",
        "agency_name": "Name der Agentur",
        "last_bill_end": "Ende des letzten Care Stays",
        "days_on_pause": "Tage seit dem letzten Care Stay",
        "total_paused_customers": "Gesamtzahl der Kunden in Pause"
      }
    },

    "get_customer_history": {
      "description": "Ruft die vollständige Geschichte eines Kunden ab, einschließlich aller Care Stays und Verträge",
      "required_parameters": ["customer_name"],
      "optional_parameters": ["seller_id", "limit"],
      "sql_template": "WITH customer_info AS (SELECT l._id AS lead_id, l.seller_id, la.first_name, la.last_name, l.created_at AS lead_created_at, h._id AS household_id FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.leads` AS l JOIN `gcpxbixpflegehilfesenioren.dataform_staging.leads_and_seller_and_source_with_address` AS la ON l._id = la._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.households` AS h ON h.lead_id = l._id WHERE (@seller_id IS NULL OR l.seller_id = @seller_id) AND (LOWER(la.first_name) LIKE CONCAT('%', LOWER(@customer_name), '%') OR LOWER(la.last_name) LIKE CONCAT('%', LOWER(@customer_name), '%'))), contracts AS (SELECT c._id AS contract_id, c.archived, c.termination_reason, c.created_at AS contract_created_at, c.updated_at AS contract_updated_at, ci.lead_id, ci.first_name, ci.last_name, agencies.name AS agency_name FROM customer_info ci JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` AS c ON ci.household_id = c.household_id LEFT JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.agencies` AS agencies ON c.agency_id = agencies._id), care_stays AS (SELECT cs._id AS care_stay_id, cs.bill_start, cs.bill_end, cs.stage, cs.prov_seller, co.contract_id, co.lead_id, co.first_name, co.last_name, co.agency_name, cg.first_name AS caregiver_first_name, cg.last_name AS caregiver_last_name, DATE_DIFF(DATE(TIMESTAMP(cs.bill_end)), DATE(TIMESTAMP(cs.bill_start)), DAY) AS care_stay_duration_days FROM contracts co JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS cs ON co.contract_id = cs.contract_id LEFT JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_giver_instances` cgi ON cs.care_giver_instance_id = cgi._id LEFT JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_givers` cg ON cgi.care_giver_id = cg._id WHERE cs.stage = 'Bestätigt'), tickets AS (SELECT t._id AS ticket_id, t.subject, t.created_at AS ticket_created_at, t.ticketable_type, CASE WHEN t.ticketable_type = 'Lead' THEN ci.lead_id WHEN t.ticketable_type = 'Contract' THEN t.ticketable_id WHEN t.ticketable_type = 'CareStay' THEN cs1.contract_id END AS related_id, ci.lead_id FROM customer_info ci LEFT JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.tickets` t ON (t.ticketable_type = 'Lead' AND t.ticketable_id = ci.lead_id) LEFT JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` cs1 ON (t.ticketable_type = 'CareStay' AND t.ticketable_id = cs1._id) WHERE t._id IS NOT NULL), contract_stats AS (SELECT lead_id, COUNT(*) AS contracts_count, MIN(contract_created_at) AS first_contract_date, STRING_AGG(DISTINCT agency_name, ', ') AS agencies, STRING_AGG(FORMAT('Vertrag vom %s mit %s, Status: %s', FORMAT_TIMESTAMP('%d.%m.%Y', TIMESTAMP(contract_created_at)), agency_name, CASE WHEN archived = 'false' THEN 'Aktiv' ELSE 'Beendet' END), '\\n' ORDER BY contract_created_at) AS contracts_summary FROM contracts GROUP BY lead_id), care_stay_stats AS (SELECT lead_id, COUNT(*) AS care_stays_count, MIN(bill_start) AS first_care_stay_date, SUM(care_stay_duration_days) AS total_care_days, STRING_AGG(FORMAT('Einsatz vom %s bis %s (%d Tage), Pflegekraft: %s %s, Provision: %d€', FORMAT_TIMESTAMP('%d.%m.%Y', TIMESTAMP(bill_start)), FORMAT_TIMESTAMP('%d.%m.%Y', TIMESTAMP(bill_end)), care_stay_duration_days, caregiver_first_name, caregiver_last_name, CAST(prov_seller AS INT64)), '\\n' ORDER BY bill_start) AS care_stays_summary FROM care_stays GROUP BY lead_id), ticket_stats AS (SELECT lead_id, COUNT(*) AS tickets_count, STRING_AGG(FORMAT('Ticket vom %s: %s (Typ: %s)', FORMAT_TIMESTAMP('%d.%m.%Y', TIMESTAMP(ticket_created_at)), subject, ticketable_type), '\\n' ORDER BY ticket_created_at DESC) AS tickets_summary FROM tickets GROUP BY lead_id) SELECT ci.lead_id, ci.first_name, ci.last_name, ci.lead_created_at, COALESCE(cs.contracts_count, 0) AS contracts_count, COALESCE(css.care_stays_count, 0) AS care_stays_count, COALESCE(ts.tickets_count, 0) AS tickets_count, cs.first_contract_date, css.first_care_stay_date, COALESCE(css.total_care_days, 0) AS total_care_days, cs.agencies, cs.contracts_summary, css.care_stays_summary, ts.tickets_summary FROM customer_info ci LEFT JOIN contract_stats cs ON ci.lead_id = cs.lead_id LEFT JOIN care_stay_stats css ON ci.lead_id = css.lead_id LEFT JOIN ticket_stats ts ON ci.lead_id = ts.lead_id ORDER BY ci.last_name, ci.first_name LIMIT @limit",
      "default_values": {
        "limit": 1000
      },
      "result_structure": {
        "lead_id": "ID des Leads",
        "first_name": "Vorname des Kunden",
        "last_name": "Nachname des Kunden",
        "lead_created_at": "Erstellungsdatum des Leads",
        "contracts_count": "Anzahl der Verträge",
        "care_stays_count": "Anzahl der Care Stays",
        "first_contract_date": "Datum des ersten Vertrags",
        "first_care_stay_date": "Datum des ersten Care Stays",
        "total_care_days": "Gesamtzahl der Betreuungstage",
        "agencies": "Liste der Agenturen",
        "contracts_summary": "Zusammenfassung aller Verträge",
        "care_stays_summary": "Zusammenfassung aller Care Stays"
      }
    },

    "get_customer_tickets": {
      "description": "Ruft alle geschriebenen Tickets eines Kunden ab",
      "required_parameters": ["customer_name"],
      "optional_parameters": ["seller_id", "limit"],
      "sql_template": "WITH customer_info AS (SELECT l._id AS lead_id, l.seller_id, la.first_name, la.last_name, l.created_at AS lead_created_at, h._id AS household_id FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.leads` AS l JOIN `gcpxbixpflegehilfesenioren.dataform_staging.leads_and_seller_and_source_with_address` AS la ON l._id = la._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.households` AS h ON h.lead_id = l._id WHERE (@seller_id IS NULL OR l.seller_id = @seller_id) AND (LOWER(la.first_name) LIKE CONCAT('%', LOWER(@customer_name), '%') OR LOWER(la.last_name) LIKE CONCAT('%', LOWER(@customer_name), '%'))), contracts AS (SELECT c._id AS contract_id, c.archived, c.created_at AS contract_created_at, c.updated_at AS contract_updated_at, ci.lead_id, ci.first_name, ci.last_name, agencies.name AS agency_name, c.agency_id FROM customer_info ci JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` AS c ON ci.household_id = c.household_id LEFT JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.agencies` AS agencies ON c.agency_id = agencies._id), care_stays AS (SELECT cs._id AS care_stay_id, cs.bill_start, cs.bill_end, cs.stage, cs.prov_seller, co.contract_id, co.lead_id, co.first_name, co.last_name, co.agency_name, co.agency_id, cg.first_name AS caregiver_first_name, cg.last_name AS caregiver_last_name FROM contracts co JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS cs ON co.contract_id = cs.contract_id LEFT JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_giver_instances` cgi ON cs.care_giver_instance_id = cgi._id LEFT JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_givers` cg ON cgi.care_giver_id = cg._id WHERE cs.stage = 'Bestätigt'), tickets_data AS (SELECT t._id AS ticket_id, t.subject, t.messages, t.category, t.priority, t.archived, t.logs, t.created_at AS ticket_created_at, t.updated_at AS ticket_updated_at, t.ticketable_type, t.ticketable_id, 'Lead' AS relation_source, ci.lead_id, ci.first_name, ci.last_name, NULL AS agency_id, NULL AS agency_name, NULL AS contract_id, NULL AS care_stay_id, NULL AS bill_start, NULL AS bill_end, NULL AS caregiver_first_name, NULL AS caregiver_last_name FROM customer_info ci JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.tickets` t ON t.ticketable_type = 'Lead' AND t.ticketable_id = ci.lead_id UNION ALL SELECT t._id AS ticket_id, t.subject, t.messages, t.category, t.priority, t.archived, t.logs, t.created_at AS ticket_created_at, t.updated_at AS ticket_updated_at, t.ticketable_type, t.ticketable_id, 'Contract' AS relation_source, c.lead_id, c.first_name, c.last_name, c.agency_id, c.agency_name, c.contract_id, NULL AS care_stay_id, NULL AS bill_start, NULL AS bill_end, NULL AS caregiver_first_name, NULL AS caregiver_last_name FROM contracts c JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.tickets` t ON t.ticketable_type = 'Contract' AND t.ticketable_id = c.contract_id UNION ALL SELECT t._id AS ticket_id, t.subject, t.messages, t.category, t.priority, t.archived, t.logs, t.created_at AS ticket_created_at, t.updated_at AS ticket_updated_at, t.ticketable_type, t.ticketable_id, 'CareStay' AS relation_source, cs.lead_id, cs.first_name, cs.last_name, cs.agency_id, cs.agency_name, cs.contract_id, cs.care_stay_id, cs.bill_start, cs.bill_end, cs.caregiver_first_name, cs.caregiver_last_name FROM care_stays cs JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.tickets` t ON t.ticketable_type = 'CareStay' AND t.ticketable_id = cs.care_stay_id), ticket_sellers AS (SELECT t.ticket_id, u.first_name AS seller_first_name, u.last_name AS seller_last_name FROM tickets_data t JOIN customer_info ci ON t.lead_id = ci.lead_id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.proto_users` u ON ci.seller_id = u._id), formatted_tickets AS (SELECT tickets_data.subject, tickets_data.messages, tickets_data.category, tickets_data.agency_name, FORMAT_TIMESTAMP('%d.%m.%Y %H:%M', TIMESTAMP(tickets_data.ticket_created_at)) AS created_at, FORMAT_TIMESTAMP('%d.%m.%Y %H:%M', TIMESTAMP(tickets_data.ticket_updated_at)) AS updated_at, CASE WHEN tickets_data.relation_source = 'Lead' THEN 'Kundenanfrage' WHEN tickets_data.relation_source = 'Contract' THEN 'Vertragsanfrage' WHEN tickets_data.relation_source = 'CareStay' THEN 'Einsatzanfrage' ELSE tickets_data.relation_source END AS ticket_type, CASE WHEN tickets_data.relation_source = 'Contract' THEN FORMAT('Vertrag-ID: %s, Agentur: %s', tickets_data.contract_id, tickets_data.agency_name) WHEN tickets_data.relation_source = 'CareStay' THEN FORMAT('Einsatz vom %s bis %s, Pflegekraft: %s %s, Agentur: %s', FORMAT_TIMESTAMP('%d.%m.%Y', TIMESTAMP(tickets_data.bill_start)), FORMAT_TIMESTAMP('%d.%m.%Y', TIMESTAMP(tickets_data.bill_end)), tickets_data.caregiver_first_name, tickets_data.caregiver_last_name, tickets_data.agency_name) ELSE '' END AS details, tickets_data.last_name, tickets_data.first_name, tickets_data.ticket_created_at FROM tickets_data) SELECT subject, messages AS messages_json, category, agency_name AS agency, created_at, updated_at, ticket_type, details FROM formatted_tickets ORDER BY last_name, first_name, ticket_created_at DESC LIMIT @limit",
      "default_values": {
        "limit": 500
      },
      "result_structure": {
        "subject": "Betreff des Tickets",
        "messages_json": "JSON der Nachrichten im Ticket",
        "category": "Kategorie des Tickets",
        "agency": "Name der zugehörigen Agentur",
        "created_at": "Erstellungsdatum des Tickets",
        "updated_at": "Datum der letzten Aktualisierung",
        "ticket_type": "Typ des Tickets (Kundenanfrage, Vertragsanfrage, Einsatzanfrage)",
        "details": "Zusätzliche Details zum Ticket"
      }
    },

    "get_monthly_performance": {
      "description": "Ruft monatliche Leistungskennzahlen für einen Verkäufer ab (alle aktiven Care Stays im Monat)",
      "required_parameters": ["seller_id", "start_date", "end_date"],
      "optional_parameters": [],
      "sql_template": "WITH active_care_stays AS (SELECT cs._id AS care_stay_id, cs.contract_id, cs.bill_start, cs.bill_end, cs.prov_seller, lead_names.first_name, lead_names.last_name, agencies.name AS agency_name, DATE_DIFF(DATE(TIMESTAMP(cs.bill_end)), DATE(TIMESTAMP(cs.bill_start)), DAY) AS care_stay_duration_days FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS cs JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` AS c ON cs.contract_id = c._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.households` AS h ON c.household_id = h._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.leads` AS l ON h.lead_id = l._id LEFT JOIN `gcpxbixpflegehilfesenioren.dataform_staging.leads_and_seller_and_source_with_address` AS lead_names ON l._id = lead_names._id LEFT JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.agencies` AS agencies ON c.agency_id = agencies._id WHERE l.seller_id = @seller_id AND cs.stage = 'Bestätigt' AND (DATE(TIMESTAMP(cs.bill_start)) <= @end_date AND DATE(TIMESTAMP(cs.bill_end)) >= @start_date)) SELECT COUNT(*) AS total_active_care_stays, COUNT(DISTINCT contract_id) AS total_contracts, SUM(CAST(prov_seller AS FLOAT64)) AS total_revenue, ROUND(AVG(CAST(prov_seller AS FLOAT64)), 2) AS average_revenue_per_care_stay, ROUND(AVG(care_stay_duration_days), 1) AS average_duration, FORMAT('%s - %s', FORMAT_DATE('%d.%m.%Y', @start_date), FORMAT_DATE('%d.%m.%Y', @end_date)) AS period, STRING_AGG(DISTINCT agency_name, ', ') AS active_agencies, ARRAY_TO_STRING(ARRAY(SELECT FORMAT('%s %s (%s): %d€', first_name, last_name, agency_name, CAST(prov_seller AS INT64)) FROM active_care_stays GROUP BY first_name, last_name, agency_name, prov_seller ORDER BY first_name, last_name), '\\n') AS customer_details FROM active_care_stays",
      "default_values": {},
      "result_structure": {
        "total_active_care_stays": "Gesamtzahl aktiver Care Stays im Zeitraum",
        "total_revenue": "Gesamtumsatz im Zeitraum",
        "average_revenue_per_care_stay": "Durchschnittlicher Umsatz pro Care Stay",
        "average_duration": "Durchschnittliche Dauer der Care Stays",
        "period": "Ausgewerteter Zeitraum",
        "active_agencies": "Aktive Agenturen im Zeitraum",
        "customer_details": "Detaillierte Übersicht aller Kunden mit Umsatz"
      }
    },

    "get_revenue_by_agency": {
      "description": "Ruft Umsatz nach Agentur für einen Verkäufer ab mit Detailinformationen zu Kunden",
      "required_parameters": ["seller_id"],
      "optional_parameters": ["agency_name", "start_date", "end_date"],
      "sql_template": "WITH agency_revenue AS (SELECT cs._id AS care_stay_id, a.name AS agency_name, lead_names.first_name, lead_names.last_name, cs.bill_start, cs.bill_end, CAST(cs.prov_seller AS FLOAT64) AS revenue FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS cs JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` AS c ON cs.contract_id = c._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.agencies` AS a ON c.agency_id = a._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.households` AS h ON c.household_id = h._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.leads` AS l ON h.lead_id = l._id LEFT JOIN `gcpxbixpflegehilfesenioren.dataform_staging.leads_and_seller_and_source_with_address` AS lead_names ON l._id = lead_names._id WHERE l.seller_id = @seller_id AND cs.stage = 'Bestätigt' AND (@agency_name IS NULL OR LOWER(a.name) LIKE CONCAT('%', LOWER(@agency_name), '%')) AND (@start_date IS NULL OR DATE(TIMESTAMP(cs.bill_start)) <= @end_date) AND (@end_date IS NULL OR DATE(TIMESTAMP(cs.bill_end)) >= @start_date)) SELECT agency_name, COUNT(DISTINCT care_stay_id) AS care_stays_count, SUM(revenue) AS total_revenue, ARRAY_TO_STRING(ARRAY(SELECT DISTINCT FORMAT('%s %s: %d€ (Einsatz vom %s bis %s)', first_name, last_name, CAST(revenue AS INT64), FORMAT_TIMESTAMP('%d.%m.%Y', TIMESTAMP(bill_start)), FORMAT_TIMESTAMP('%d.%m.%Y', TIMESTAMP(bill_end))) FROM agency_revenue ar WHERE ar.agency_name = agency_revenue.agency_name GROUP BY first_name, last_name, revenue, bill_start, bill_end ORDER BY first_name, last_name), '\\n') AS revenue_details FROM agency_revenue GROUP BY agency_name ORDER BY total_revenue DESC",
      "default_values": {
        "start_date": "DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY)",
        "end_date": "CURRENT_DATE()"
      },
      "result_structure": {
        "agency_name": "Name der Agentur",
        "care_stays_count": "Anzahl der Care Stays bei dieser Agentur",
        "total_revenue": "Gesamtumsatz mit dieser Agentur",
        "revenue_details": "Detaillierte Auflistung aller Umsätze mit Kundennamen"
      }
    },

    "get_leads_converted_to_customers": {
      "description": "NICHT DIE ABSCHLUSSQUOTE! Ruft nur Leads ab, die im angegebenen Zeitraum zu Kunden konvertiert wurden (ohne vorherige Verträge). Es zählen nur Leads, die auch in den angegebenen Zeitraum erstellt/gekauft wurden. ",
      "required_parameters": ["seller_id", "start_date", "end_date"],
      "optional_parameters": ["limit"],
      "sql_template": "WITH new_leads AS (SELECT l._id AS lead_id, l.created_at, la.first_name, la.last_name FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.leads` AS l JOIN `gcpxbixpflegehilfesenioren.dataform_staging.leads_and_seller_and_source_with_address` AS la ON l._id = la._id WHERE l.seller_id = @seller_id AND DATE(TIMESTAMP(l.created_at)) BETWEEN @start_date AND @end_date), converted_leads AS (SELECT nl.lead_id, nl.first_name, nl.last_name, nl.created_at AS lead_created_at, MIN(c.created_at) AS first_contract_date, agencies.name AS agency_name, (SELECT COUNT(*) FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` cs WHERE cs.contract_id = c._id AND cs.stage = 'Bestätigt') AS care_stays_count FROM new_leads nl JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.households` h ON nl.lead_id = h.lead_id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` c ON h._id = c.household_id LEFT JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.agencies` agencies ON c.agency_id = agencies._id GROUP BY nl.lead_id, nl.first_name, nl.last_name, nl.created_at, agencies.name HAVING MIN(c.created_at) IS NOT NULL AND NOT EXISTS (SELECT 1 FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` c2 JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` cs2 ON c2._id = cs2.contract_id AND cs2.stage = 'Bestätigt' WHERE c2.household_id = h._id AND c2._id != c._id AND c2.created_at < @start_date)) SELECT lead_id, first_name, last_name, lead_created_at, first_contract_date, agency_name, care_stays_count, DATE_DIFF(DATE(TIMESTAMP(first_contract_date)), DATE(TIMESTAMP(lead_created_at)), DAY) AS days_to_conversion, (SELECT COUNT(*) FROM converted_leads) AS total_converted_leads_count FROM converted_leads ORDER BY lead_created_at DESC LIMIT @limit",
      "default_values": {
        "limit": 5000
      },
      "result_structure": {
        "lead_id": "ID des Leads",
        "first_name": "Vorname des Kunden",
        "last_name": "Nachname des Kunden",
        "lead_created_at": "Erstellungsdatum des Leads",
        "first_contract_date": "Datum des ersten Vertrags",
        "agency_name": "Name der Agentur",
        "care_stays_count": "Anzahl der Care Stays",
        "days_to_conversion": "Tage von Lead zu Vertrag",
        "total_converted_leads_count": "Gesamtanzahl konvertierter Leads"
      }
    },

    "get_care_givers_for_customer": {
      "description": "Ruft Pflegekräfte für einen bestimmten Kunden ab",
      "required_parameters": ["customer_name"],
      "optional_parameters": ["seller_id", "limit"],
      "sql_template": "WITH customer_info AS (SELECT l._id AS lead_id, l.seller_id FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.leads` AS l JOIN `gcpxbixpflegehilfesenioren.dataform_staging.leads_and_seller_and_source_with_address` AS la ON l._id = la._id WHERE (@seller_id IS NULL OR l.seller_id = @seller_id) AND (LOWER(la.first_name) LIKE CONCAT('%', LOWER(@customer_name), '%') OR LOWER(la.last_name) LIKE CONCAT('%', LOWER(@customer_name), '%'))) SELECT cg.first_name AS caregiver_first_name, cg.last_name AS caregiver_last_name, cg.gender AS caregiver_gender, cs.bill_start, cs.bill_end, cs.stage, agencies.name AS agency_name, lead_names.first_name AS customer_first_name, lead_names.last_name AS customer_last_name, DATE_DIFF(DATE(TIMESTAMP(cs.bill_end)), DATE(TIMESTAMP(cs.bill_start)), DAY) AS care_stay_duration_days FROM customer_info ci JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.households` h ON h.lead_id = ci.lead_id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` c ON h._id = c.household_id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` cs ON c._id = cs.contract_id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_giver_instances` cgi ON cs.care_giver_instance_id = cgi._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_givers` cg ON cgi.care_giver_id = cg._id LEFT JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.agencies` agencies ON c.agency_id = agencies._id LEFT JOIN `gcpxbixpflegehilfesenioren.dataform_staging.leads_and_seller_and_source_with_address` AS lead_names ON ci.lead_id = lead_names._id WHERE cs.stage = 'Bestätigt' ORDER BY cs.bill_start DESC LIMIT @limit",
      "default_values": {
        "limit": 100
      },
      "result_structure": {
        "caregiver_first_name": "Vorname der Pflegekraft",
        "caregiver_last_name": "Nachname der Pflegekraft",
        "caregiver_gender": "Geschlecht der Pflegekraft",
        "bill_start": "Startdatum der Abrechnung",
        "bill_end": "Enddatum der Abrechnung",
        "stage": "Status des Care Stays",
        "agency_name": "Name der Agentur",
        "customer_first_name": "Vorname des Kunden",
        "customer_last_name": "Nachname des Kunden",
        "care_stay_duration_days": "Dauer des Care Stays in Tagen"
      }
    },

    "get_leads": {
      "description": "Ruft alle Leads eines Verkäufers in einem bestimmten Zeitraum ab mit detaillierten Informationen",
      "required_parameters": ["seller_id", "start_date", "end_date"],
      "optional_parameters": ["limit"],
      "sql_template": "WITH seller_leads AS (SELECT l._id AS lead_id, l.seller_id, l.created_at, l.updated_at, l.price, l.cost, l.purchased, l.assigned_at, l.seller_touched_at, l.contacted, l.auto_assigned, l.assign_pooled, l.archived, l.reclaimed, l.reclaim_reason, l.reclaimed_at, l.reclaim_confirmed, l.reclaim_bill_id, l.discount_level, l.discount_seller, l.prov_seller, l.prov_pfs, l.multiplier, l.rating_requested, l.rating_auto_request, l.notes, l.hot_notes, l.source_data, l.tracks, l.logs, l.google_contact, l.google_etag, la.first_name, la.last_name, la.email FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.leads` AS l JOIN `gcpxbixpflegehilfesenioren.dataform_staging.leads_and_seller_and_source_with_address` AS la ON l._id = la._id WHERE l.seller_id = @seller_id AND TIMESTAMP(l.created_at) >= TIMESTAMP(@start_date) AND TIMESTAMP(l.created_at) <= TIMESTAMP(@end_date)) SELECT *, (SELECT COUNT(*) FROM seller_leads) AS total_leads_in_selected_period FROM seller_leads ORDER BY last_name, first_name LIMIT @limit",
      "default_values": {
        "limit": 5000,
        "start_date": "DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY)",
        "end_date": "CURRENT_DATE()"
      },
      "parameter_types": {
        "limit": "int",
        "start_date": "date",
        "end_date": "date"
      },
      "result_structure": {
        "lead_id": "ID des Leads",
        "first_name": "Vorname des Leads",
        "last_name": "Nachname des Leads",
        "email": "E-Mail-Adresse des Leads",
        "created_at": "Erstellungsdatum des Leads",
        "contacted": "Wurde der Lead kontaktiert",
        "total_leads_in_selected_period": "Gesamtzahl der Leads im gewählten Zeitraum"
      }
    },
    
    "get_leads_count": {
      "description": "Zählt die Anzahl der Leads eines Verkäufers in einem bestimmten Zeitraum",
      "required_parameters": ["seller_id", "start_date", "end_date"],
      "optional_parameters": [],
      "sql_template": "SELECT COUNT(*) AS leads_count FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.leads` AS l WHERE l.seller_id = @seller_id AND TIMESTAMP(l.created_at) >= TIMESTAMP(@start_date) AND TIMESTAMP(l.created_at) <= TIMESTAMP(@end_date)",
      "default_values": {
        "start_date": "DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY)",
        "end_date": "CURRENT_DATE()"
      },
      "parameter_types": {
        "start_date": "date",
        "end_date": "date"
      },
      "result_structure": {
        "leads_count": "Anzahl der Leads im gewählten Zeitraum"
      }
    },
    
    "get_cvr_lead_contract": {
      "description": "Berechnet die Conversion Rate (Abschlussquote) zwischen Leads und Verträgen in einem Zeitraum",
      "required_parameters": ["seller_id", "start_date", "end_date"],
      "optional_parameters": [],
      "sql_template": "WITH lead_data AS (SELECT COUNT(*) AS total_leads, COUNT(CASE WHEN l.reclaimed = 'false' THEN 1 END) AS net_leads FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.leads` AS l WHERE l.seller_id = @seller_id AND TIMESTAMP(l.created_at) >= TIMESTAMP(@start_date) AND TIMESTAMP(l.created_at) <= TIMESTAMP(@end_date)), all_contracts AS (SELECT c._id AS contract_id, CASE WHEN EXISTS (SELECT 1 FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` AS other_c JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS other_cs ON other_c._id = other_cs.contract_id AND other_cs.stage = 'Bestätigt' WHERE other_c.household_id = c.household_id AND other_c._id != c._id AND other_c.created_at > c.created_at) AND EXISTS (SELECT 1 FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS confirmed_cs WHERE confirmed_cs.contract_id = c._id AND confirmed_cs.stage = 'Bestätigt') THEN 'Agenturwechsel' ELSE 'Kein Wechsel' END AS contract_type FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` AS c JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.households` AS h ON c.household_id = h._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.leads` AS l ON h.lead_id = l._id WHERE l.seller_id = @seller_id AND TIMESTAMP(c.created_at) >= TIMESTAMP(@start_date) AND TIMESTAMP(c.created_at) <= TIMESTAMP(@end_date)), contract_data AS (SELECT COUNT(*) AS total_contracts, COUNT(CASE WHEN contract_type = 'Kein Wechsel' THEN 1 END) AS new_contracts, COUNT(CASE WHEN contract_type = 'Agenturwechsel' THEN 1 END) AS agency_switches FROM all_contracts) SELECT ld.total_leads, ld.net_leads, cd.new_contracts AS total_contracts, cd.agency_switches, CASE WHEN ld.net_leads > 0 THEN ROUND(cd.new_contracts * 100.0 / ld.net_leads, 2) ELSE 0 END AS conversion_rate FROM lead_data ld CROSS JOIN contract_data cd",
      "default_values": {
        "start_date": "DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY)",
        "end_date": "CURRENT_DATE()"
      },
      "parameter_types": {
        "start_date": "date",
        "end_date": "date"
      },
      "result_structure": {
        "total_leads": "Gesamtzahl der gekauften Leads",
        "net_leads": "Anzahl der Netto-Leads (nicht zurückgefordert)",
        "total_contracts": "Anzahl der abgeschlossenen Verträge (keine Wechsel)",
        "agency_switches": "Anzahl der Agenturwechsel",
        "conversion_rate": "Abschlussquote (Conversion Rate) in Prozent"
      }
    },
    
    "get_contract_count": {
      "description": "Ermittelt die Anzahl neuer Verträge in einem Zeitraum und wie viele davon noch aktiv sind",
      "required_parameters": ["seller_id", "start_date", "end_date"],
      "optional_parameters": [],
      "sql_template": "WITH contracts_with_termination_reason AS (SELECT c._id AS contract_id, CASE WHEN EXISTS (SELECT 1 FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` AS other_c JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS other_cs ON other_c._id = other_cs.contract_id AND other_cs.stage = 'Bestätigt' WHERE other_c.household_id = c.household_id AND other_c._id != c._id AND other_c.created_at > c.created_at) AND EXISTS (SELECT 1 FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS confirmed_cs WHERE confirmed_cs.contract_id = c._id AND confirmed_cs.stage = 'Bestätigt') THEN 'Agenturwechsel' ELSE 'Kein Wechsel' END AS contract_type FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` AS c JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.households` AS h ON c.household_id = h._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.leads` AS l ON h.lead_id = l._id WHERE c.created_at > @start_date AND c.created_at < @end_date AND l.seller_id = @seller_id AND c.archived != \"true\"), contracts_without_termination_filter AS (SELECT c._id AS contract_id, CASE WHEN EXISTS (SELECT 1 FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` AS other_c JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS other_cs ON other_c._id = other_cs.contract_id AND other_cs.stage = 'Bestätigt' WHERE other_c.household_id = c.household_id AND other_c._id != c._id AND other_c.created_at > c.created_at) AND EXISTS (SELECT 1 FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS confirmed_cs WHERE confirmed_cs.contract_id = c._id AND confirmed_cs.stage = 'Bestätigt') THEN 'Agenturwechsel' ELSE 'Kein Wechsel' END AS contract_type FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` AS c JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.households` AS h ON c.household_id = h._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.leads` AS l ON h.lead_id = l._id WHERE c.created_at > @start_date AND c.created_at < @end_date AND l.seller_id = @seller_id) SELECT 'neue Verträge noch aktiv' AS query_type, COUNT(*) AS total_active_contracts, COUNT(CASE WHEN contract_type = 'Kein Wechsel' THEN 1 END) AS normal_contracts_count, COUNT(CASE WHEN contract_type = 'Agenturwechsel' THEN 1 END) AS agency_change_contracts_count FROM contracts_with_termination_reason UNION ALL SELECT 'Alle neuen Verträge' AS query_type, COUNT(*) AS total_contracts, COUNT(CASE WHEN contract_type = 'Kein Wechsel' THEN 1 END) AS normal_contracts_count, COUNT(CASE WHEN contract_type = 'Agenturwechsel' THEN 1 END) AS agency_change_contracts_count FROM contracts_without_termination_filter",
      "default_values": {
        "start_date": "DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY)",
        "end_date": "CURRENT_DATE()"
      },
      "parameter_types": {
        "start_date": "date",
        "end_date": "date"
      },
      "result_structure": {
        "query_type": "Typ der Abfrage",
        "total_contracts": "Gesamtzahl der Verträge",
        "normal_contracts_count": "Anzahl der Neuverträge",
        "agency_change_contracts_count": "Anzahl der Agenturwechsel"
      }
    },
    
    "get_contract_details": {
      "description": "Liefert detaillierte Informationen zu allen Neuverträgen im angegebenen Zeitraum mit Namen, Datum und Provision",
      "required_parameters": ["seller_id", "start_date", "end_date"],
      "optional_parameters": ["limit"],
      "sql_template": "WITH all_contracts AS (SELECT c._id AS contract_id, c.created_at AS contract_created_at, c.termination_reason, c.provision_level, c.discount_level, c.agency_signed, c.agency_id, c.discount_seller, c.prov_pfs, c.paused_until, c.prov_seller, l._id AS lead_id, lead_names.first_name, lead_names.last_name, CASE WHEN NOT EXISTS (SELECT 1 FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS confirmed_cs WHERE confirmed_cs.contract_id = c._id AND confirmed_cs.stage = 'Bestätigt') AND EXISTS (SELECT 1 FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS aborted_cs WHERE aborted_cs.contract_id = c._id AND aborted_cs.stage = 'Abgebrochen') THEN 'Nicht ernsthaft' WHEN EXISTS (SELECT 1 FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` AS other_c JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS other_cs ON other_c._id = other_cs.contract_id AND other_cs.stage = 'Bestätigt' WHERE other_c.household_id = c.household_id AND other_c._id != c._id AND other_c.created_at > c.created_at) AND EXISTS (SELECT 1 FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS confirmed_cs WHERE confirmed_cs.contract_id = c._id AND confirmed_cs.stage = 'Bestätigt') THEN 'Agenturwechsel' ELSE 'Endgueltige Kuendigung' END AS termination_type FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` AS c JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.households` AS h ON c.household_id = h._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.leads` AS l ON h.lead_id = l._id LEFT JOIN `gcpxbixpflegehilfesenioren.dataform_staging.leads_and_seller_and_source_with_address` AS lead_names ON l._id = lead_names._id WHERE c.created_at > @start_date AND c.created_at < @end_date AND l.seller_id = @seller_id), final_terminations AS (SELECT * FROM all_contracts WHERE termination_type = 'Endgueltige Kuendigung') SELECT last_name, first_name, contract_created_at, termination_reason, agency_id, discount_seller, prov_pfs, paused_until, prov_seller, (SELECT COUNT(*) FROM all_contracts WHERE termination_type = 'Agenturwechsel') AS agency_switches, (SELECT COUNT(*) FROM all_contracts) AS total_new_contracts FROM all_contracts ORDER BY contract_created_at DESC LIMIT @limit",
      "default_values": {
        "limit": 100,
        "start_date": "DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY)",
        "end_date": "CURRENT_DATE()"
      },
      "parameter_types": {
        "limit": "int",
        "start_date": "date",
        "end_date": "date"
      },
      "result_structure": {
        "last_name": "Nachname des Kunden",
        "first_name": "Vorname des Kunden",
        "contract_created_at": "Erstellungsdatum des Vertrags",
        "termination_reason": "Kündigungsgrund (falls vorhanden)",
        "prov_seller": "Provision für den Verkäufer",
        "agency_switches": "Anzahl der Agenturwechsel im Zeitraum",
        "total_new_contracts": "Gesamtzahl aller Neuabschlüsse im Zeitraum"
      }
    },
    
    "get_revenue_current_month_pro_rata": {
      "description": "Berechnet den anteiligen Umsatz für einen ausgewählten Monat basierend auf betreuten Tagen.",
      "required_parameters": ["seller_id", "start_of_month", "end_of_month", "days_in_month"],
      "optional_parameters": [],
      "sql_template": "SELECT ROUND(SUM( CASE WHEN @days_in_month > 0 THEN (COALESCE(CAST(cs.prov_seller AS FLOAT64), 0) / @days_in_month) * GREATEST(0, DATE_DIFF( LEAST(DATE(TIMESTAMP(cs.bill_end)), DATE(@end_of_month)), GREATEST(DATE(TIMESTAMP(cs.bill_start)), DATE(@start_of_month)), DAY ) + 1) ELSE 0 END ), 2) AS total_monthly_pro_rata_revenue FROM `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.care_stays` AS cs JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.contracts` AS c ON cs.contract_id = c._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.households` AS h ON c.household_id = h._id JOIN `gcpxbixpflegehilfesenioren.PflegehilfeSeniore_BI.leads` AS l ON h.lead_id = l._id WHERE l.seller_id = @seller_id AND cs.stage = 'Bestätigt' AND DATE(TIMESTAMP(cs.bill_start)) <= DATE(@end_of_month) AND DATE(TIMESTAMP(cs.bill_end)) >= DATE(@start_of_month)",
      "default_values": {},
      "result_structure": {
        "total_monthly_pro_rata_revenue": "Summe der anteiligen Provisionen im laufenden Monat"
      }
    }
  }
}
