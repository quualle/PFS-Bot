<div class="business-content">
    <div class="business-header">
        <h2>My Business</h2>
    </div>

    <div class="business-tabs">
        <button class="business-tab active" data-tab="overview">Übersicht</button>
        <button class="business-tab" data-tab="kpi">Meine KPIs</button>
        <button class="business-tab" data-tab="customers">Meine Kunden</button>
    </div>

    <div id="overview-tab" class="tab-content active">
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Aktive Kunden (Heute)</div>
                <div class="widget-content" id="active-customers-now-widget">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Daten werden geladen...</div>
                    </div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-header">Abschlussquote (letzte 30 Tage)</div>
                <div class="widget-content" id="conversion-rate-widget">
                    <div class="customer-count">0%</div>
                </div>
            </div>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Umsatz</div>
                <div class="widget-content">
                    <div class="customer-count" id="total-revenue">0 €</div>
                    <div class="month-selector">
                        <select id="month-select" class="month-select">
                            <option value="0">Aktueller Monat</option>
                            <option value="1">Letzter Monat</option>
                            <option value="2">Vor 2 Monaten</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-header">Neue Verträge (letzte 14 Tage)</div>
                <div class="widget-content" id="new-contracts-widget">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Daten werden geladen...</div>
                    </div>
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="new-contracts">0</div>
                            <div class="metric-label">Neu</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="agency-switches">0</div>
                            <div class="metric-label">Agenturwechsel</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Neue Verträge (noch aktiv)</div>
                <div class="widget-content" id="active-contracts-widget">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Daten werden geladen...</div>
                    </div>
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="active-new-contracts">0</div>
                            <div class="metric-label">Neu</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="active-agency-switches">0</div>
                            <div class="metric-label">Agenturwechsel</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-header">Kündigungen</div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="serious-terminations">0</div>
                            <div class="metric-label">Ernst</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="agency-change-terminations">0</div>
                            <div class="metric-label">Agenturwechsel</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="kpi-tab" class="tab-content">
        <div class="date-range-selector" style="margin-bottom: 15px;">
            <input type="date" class="date-input" id="kpi-start-date">
            <input type="date" class="date-input" id="kpi-end-date">
            <button class="date-range-button" id="update-kpi-range-btn">Aktualisieren</button>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Abschlussquote <span id="kpi-closing-rate-date-range" style="font-weight: normal; font-size: 0.9em;"></span></div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="closing-rate-percent">0%</div>
                            <div class="metric-label">Prozentual</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="closing-rate-absolute">0/0</div>
                            <div class="metric-label">Absolut</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-header">Lead zu EB Conversion</div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="lead-eb-percent">0%</div>
                            <div class="metric-label">Prozentual</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="lead-eb-absolute">0/0</div>
                            <div class="metric-label">Absolut</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">EB zu Posting Conversion</div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="eb-posting-percent">0%</div>
                            <div class="metric-label">Prozentual</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="eb-posting-absolute">0/0</div>
                            <div class="metric-label">Absolut</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-header">Posting zu Vertrag Conversion</div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="posting-contract-percent">0%</div>
                            <div class="metric-label">Prozentual</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="posting-contract-absolute">0/0</div>
                            <div class="metric-label">Absolut</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Kündigungsquote</div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="termination-rate-percent">0%</div>
                            <div class="metric-label">Prozentual</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="termination-rate-absolute">0/0</div>
                            <div class="metric-label">Absolut</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="customers-tab" class="tab-content">
        <div class="widget-row">
            <div class="wide-widget">
                <div class="widget-header">Aktive Kunden</div>
                <div class="widget-content">
                    <div id="active-customers-list-container">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <div>Kundendaten werden geladen...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Neue Kunden (14 Tage)</div>
                <div class="widget-content" id="new-customers-container">
                    <div class="customer-count">0</div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-header">Kunden in Pause</div>
                <div class="widget-content" id="paused-customers-container">
                    <div class="customer-count">0</div>
                </div>
            </div>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Am längsten dabei</div>
                <div class="widget-content" id="longest-customers-container">
                    <div class="customer-count">0</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Inline-JavaScript direkt im Overlay -->
<script>
    (function() {
        console.log('My Business Overlay: JavaScript wird initialisiert');
        
        // Element-Referenzen
        const activeCustomersNowWidget = document.getElementById('active-customers-now-widget');
        const activeCustomersListContainer = document.getElementById('active-customers-list-container');
        
        console.log('Active Customers Widget gefunden:', activeCustomersNowWidget !== null);
        console.log('Active Customers List Container gefunden:', activeCustomersListContainer !== null);
        
        // Sofort Daten laden, wenn das Overlay geöffnet wird
        setTimeout(loadDashboardDataDirectly, 500);
        
        // Funktion zum direkten Laden der Dashboard-Daten
        function loadDashboardDataDirectly() {
            console.log('Direktes Laden der Dashboard-Daten wird gestartet');
            
            // Loading-Status anzeigen
            if (activeCustomersNowWidget) {
                activeCustomersNowWidget.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Direktes Laden...</div>
                    </div>
                `;
            }
            
            if (activeCustomersListContainer) {
                activeCustomersListContainer.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Direktes Laden der Kundendaten...</div>
                    </div>
                `;
            }
            
            // Weitere Widgets mit Ladeanzeige aktualisieren
            document.getElementById('conversion-rate-widget').innerHTML = '<div class="loading-spinner"><div class="spinner"></div><div>Laden...</div></div>';
            setElementText('new-contracts', '...');
            setElementText('agency-switches', '...');
            setElementText('serious-terminations', '...');
            setElementText('agency-change-terminations', '...');
            setElementText('active-new-contracts', '...');
            setElementText('active-agency-switches', '...');
            
            // Direkte XHR-Anfrage
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/get_dashboard_data', true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.setRequestHeader('Cache-Control', 'no-cache, no-store, must-revalidate');
            
            xhr.onreadystatechange = function() {
                if (this.readyState === 4) {
                    console.log('XHR Status:', this.status);
                    console.log('XHR Response Anfang:', this.responseText.substring(0, 100));
                    
                    if (this.status === 200) {
                        try {
                            const data = JSON.parse(this.responseText);
                            console.log('Dashboard-Daten erfolgreich geladen:', data);
                            
                            // Kundenzahl aktualisieren
                            if (activeCustomersNowWidget) {
                                activeCustomersNowWidget.innerHTML = `
                                    <div class="customer-count">${data.count || 0}</div>
                                `;
                                console.log('Kundenzahl aktualisiert:', data.count);
                            }
                            
                            // Kundenliste aktualisieren
                            updateCustomerList(data.data);
                            
                            // Gesamtumsatz Pro Rata (NEUE METHODE)
                            const totalRevenueElementNew = document.getElementById('total-revenue');
                            if (totalRevenueElementNew && data.pro_rata_revenue !== undefined) {
                                const proRataRevenue = parseFloat(data.pro_rata_revenue) || 0;
                                totalRevenueElementNew.textContent = `${proRataRevenue.toFixed(2)} €`;
                                console.log('Gesamtumsatz aktualisiert (Pro Rata Methode):', proRataRevenue.toFixed(2));
                            } else if (totalRevenueElementNew) {
                                // Fallback, falls Wert nicht vorhanden
                                totalRevenueElementNew.textContent = '0.00 €';
                                console.log('Gesamtumsatz Pro Rata konnte nicht geladen werden');
                            }
                            
                            // Abschlussquote aktualisieren
                            const conversionRateWidget = document.getElementById('conversion-rate-widget');
                            if (conversionRateWidget && data.conversion_rate) {
                                const rate = data.conversion_rate.conversion_rate || 0;
                                conversionRateWidget.innerHTML = `<div class="customer-count">${rate}%</div>`;
                                console.log('Abschlussquote aktualisiert:', rate);
                            } else if (conversionRateWidget) {
                                conversionRateWidget.innerHTML = `<div class="customer-count">0%</div>`;
                            }
                            
                            // Neue Verträge aktualisieren
                            if (data.new_contracts) {
                                // Spinner entfernen
                                hideLoadingSpinner('new-contracts-widget');
                                
                                // Echte neue Verträge
                                const newContractsCount = data.new_contracts.normal_contracts_count || 0;
                                setElementText('new-contracts', newContractsCount);
                                
                                // Agenturwechsel
                                const agencyChangesCount = data.new_contracts.agency_change_contracts_count || 0;
                                setElementText('agency-switches', agencyChangesCount);
                                
                                console.log('Neue Verträge aktualisiert:', newContractsCount, 'neu,', agencyChangesCount, 'Agenturwechsel');
                            }
                            
                            // Aktive neue Verträge aktualisieren
                            if (data.active_new_contracts || data.new_contracts) {
                                const activeData = data.active_new_contracts ? data.active_new_contracts : data.new_contracts;
                                // Spinner entfernen
                                hideLoadingSpinner('active-contracts-widget');
                                
                                // Echte neue Verträge
                                const activeNewContractsCount = activeData.normal_contracts_count || 0;
                                setElementText('active-new-contracts', activeNewContractsCount);
                                
                                // Agenturwechsel
                                const activeAgencyChangesCount = activeData.agency_change_contracts_count || 0;
                                setElementText('active-agency-switches', activeAgencyChangesCount);
                                
                                console.log('Aktive neue Verträge aktualisiert:', activeNewContractsCount, 'neu,', activeAgencyChangesCount, 'Agenturwechsel');
                            }
                            
                            // Kündigungen aktualisieren
                            if (data.terminations) {
                                // Ernsthafte Kündigungen
                                const seriousTerminations = data.terminations.serious_terminations_count || 0;
                                setElementText('serious-terminations', seriousTerminations);
                                
                                // Agenturwechsel
                                const agencyChangeTerminations = data.terminations.agency_switch_count || 0;
                                setElementText('agency-change-terminations', agencyChangeTerminations);
                                
                                console.log('Kündigungen aktualisiert:', seriousTerminations, 'ernsthaft,', agencyChangeTerminations, 'Agenturwechsel');
                            }
                            
                        } catch (e) {
                            console.error('Fehler beim Parsen der JSON-Antwort:', e);
                            showErrorMessage('Fehler beim Parsen der Daten: ' + e.message);
                        }
                    } else {
                        console.error('XHR-Fehler:', this.status);
                        showErrorMessage('Server-Fehler: ' + this.status);
                    }
                }
            };
            
            xhr.onerror = function() {
                console.error('Netzwerkfehler bei der XHR-Anfrage');
                showErrorMessage('Netzwerkfehler bei der Anfrage');
            };
            
            xhr.send();
            console.log('XHR-Anfrage gesendet');
        }
        
        // Hilfsfunktion zur Textaktualisierung von Elementen
        function setElementText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            } else {
                console.warn(`Element mit ID ${elementId} nicht gefunden`);
            }
        }
        
        // Hilfsfunktion zum Ausblenden des Loading-Spinners
        function hideLoadingSpinner(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                const spinner = container.querySelector('.loading-spinner');
                if (spinner) {
                    spinner.style.display = 'none';
                }
            } else {
                console.warn(`Container mit ID ${containerId} nicht gefunden`);
            }
        }
        
        // Hilfsfunktion zur Fehleranzeige
        function showErrorMessage(message) {
            const errorHtml = `
                <div class="error-message">
                    <div>Fehler</div>
                    <div class="error-details">${message}</div>
                </div>
            `;
            
            if (activeCustomersNowWidget) {
                activeCustomersNowWidget.innerHTML = errorHtml;
            }
            
            if (activeCustomersListContainer) {
                activeCustomersListContainer.innerHTML = errorHtml;
            }
        }
        
        // Hilfsfunktion zum Formatieren des Datums
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            if (isNaN(date)) return '';
            
            return date.toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        // Funktion zum Aktualisieren der Kundenliste
        function updateCustomerList(customers) {
            if (activeCustomersListContainer && customers && customers.length > 0) {
                let customersHtml = '<div class="customer-list">';
                
                customers.forEach(function(customer) {
                    customersHtml += `
                        <div class="customer-item">
                            <div class="customer-name">${customer.first_name || ''} ${customer.last_name || ''}</div>
                            <div class="customer-agency">${customer.agency_name || 'Keine Agentur'}</div>
                            <div class="customer-since">Kunde seit: <span>${formatDate(customer.bill_start) || 'unbekannt'}</span></div>
                        </div>
                    `;
                });
                
                customersHtml += '</div>';
                activeCustomersListContainer.innerHTML = customersHtml;
                console.log('Kundenliste aktualisiert mit', customers.length, 'Kunden');
            } else if (activeCustomersListContainer) {
                activeCustomersListContainer.innerHTML = '<div class="no-data">Keine aktiven Kunden gefunden</div>';
            }
        }
        
        // Funktion zum Laden der KPI-Daten für den ausgewählten Zeitraum
        function loadKpiData(startDate, endDate) {
            console.log(`Lade KPI Daten für: ${startDate} bis ${endDate}`);
            const formattedStartDate = formatDateForDisplay(startDate);
            const formattedEndDate = formatDateForDisplay(endDate);
            setElementText('#kpi-closing-rate-date-range', `(${formattedStartDate} - ${formattedEndDate})`);
            
            // Setze KPI-Felder auf Ladezustand (optional, aber gut für UX)
            setElementText('#closing-rate-percent', '...');
            setElementText('#closing-rate-absolute', '...');
            setElementText('#lead-eb-percent', '...');
            setElementText('#lead-eb-absolute', '...');
            setElementText('#eb-posting-percent', '...');
            setElementText('#eb-posting-absolute', '...');
            setElementText('#posting-contract-percent', '...');
            setElementText('#posting-contract-absolute', '...');
            setElementText('#termination-rate-percent', '...');
            setElementText('#termination-rate-absolute', '...');
            
            fetch(`/get_kpi_data?start_date=${startDate}&end_date=${endDate}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('KPI Daten erhalten:', data);
                    setElementText('#closing-rate-percent', `${data.closing_rate_percent}%`);
                    setElementText('#closing-rate-absolute', data.closing_rate_absolute);
                    setElementText('#lead-eb-percent', `${data.lead_eb_percent}%`);
                    setElementText('#lead-eb-absolute', data.lead_eb_absolute);
                    setElementText('#eb-posting-percent', `${data.eb_posting_percent}%`);
                    setElementText('#eb-posting-absolute', data.eb_posting_absolute);
                    setElementText('#posting-contract-percent', `${data.posting_contract_percent}%`);
                    setElementText('#posting-contract-absolute', data.posting_contract_absolute);
                    setElementText('#termination-rate-percent', `${data.termination_rate_percent}%`);
                    setElementText('#termination-rate-absolute', data.termination_rate_absolute);
                })
                .catch(error => {
                    console.error('Fehler beim Laden der KPI-Daten:', error);
                    showErrorMessage('Fehler beim Laden der KPI Daten.');
                    // Setze Fehlerstatus für KPI-Felder
                    setElementText('#kpi-closing-rate-date-range', '(Fehler)');
                    setElementText('#closing-rate-percent', 'Fehler');
                    setElementText('#closing-rate-absolute', 'Fehler');
                    // ... für andere KPI-Felder ebenso
                });
        }
        
        // Hilfsfunktion zum Formatieren des Datums für die Anzeige (TT.MM.JJJJ)
        function formatDateForDisplay(dateString) {
            const [year, month, day] = dateString.split('-');
            return `${day}.${month}.${year}`;
        }
        
        // Initialisierung des Datumsbereichs und Laden der KPIs
        function initializeKpiDateRangeAndLoad() {
            const endDateInput = document.getElementById('kpi-end-date');
            const startDateInput = document.getElementById('kpi-start-date');
            const updateButton = document.getElementById('update-kpi-range-btn');
            
            if (!startDateInput || !endDateInput || !updateButton) {
                console.error('Datumseingabe-Elemente oder Button für KPIs nicht gefunden.');
                return;
            }
            
            // Setze Standarddatum (letzte 30 Tage)
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            const defaultEndDate = formatDate(today);
            const defaultStartDate = formatDate(thirtyDaysAgo);
            
            endDateInput.value = defaultEndDate;
            startDateInput.value = defaultStartDate;
            
            // Lade initiale KPI-Daten für die letzten 30 Tage
            loadKpiData(defaultStartDate, defaultEndDate);
            
            // Event Listener für den Aktualisieren-Button
            updateButton.addEventListener('click', () => {
                const selectedStartDate = startDateInput.value;
                const selectedEndDate = endDateInput.value;
                if (selectedStartDate && selectedEndDate) {
                    // Validierung (optional): Sicherstellen, dass Start vor Ende liegt
                    if (new Date(selectedStartDate) > new Date(selectedEndDate)) {
                        showErrorMessage('Das Startdatum darf nicht nach dem Enddatum liegen.');
                        return;
                    }
                    loadKpiData(selectedStartDate, selectedEndDate);
                } else {
                    showErrorMessage('Bitte wählen Sie Start- und Enddatum aus.');
                }
            });
        }
        
        // Initialisierung des KPI-Bereichs aufrufen
        initializeKpiDateRangeAndLoad();
        
        // Event Listener für Tab-Wechsel hinzufügen
        const tabs = document.querySelectorAll('.business-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Entferne 'active' von allen Tabs und Inhalten
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // Füge 'active' zum geklickten Tab und dem entsprechenden Inhalt hinzu
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                const activeContent = document.getElementById(`${tabId}-tab`);
                if (activeContent) {
                    activeContent.classList.add('active');
                }
            });
        });
        
    })();
</script>
