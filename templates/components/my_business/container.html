<div class="business-content">
    <div class="business-header">
        <h2>My Business</h2>
        <div class="business-nav-buttons">
            <button id="toggleChatBtn" class="business-nav-btn chat-toggle-btn">Zum XORA Chatbot</button>
            <a href="{{ url_for('logout') }}" class="business-nav-btn logout-btn">Ausloggen</a>
        </div>
    </div>

    <div class="business-tabs">
        <button class="business-tab active" data-tab="overview">Übersicht</button>
        <button class="business-tab" data-tab="kpi">Meine KPIs</button>
        <button class="business-tab" data-tab="customers">Meine Kunden</button>
    </div>

    <div id="overview-tab" class="tab-content active">
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Aktive Kunden (Heute)
                    <span class="info-icon">i
                        <span class="tooltip">Zeigt die Anzahl der Kunden, die gerade eben einen Pflegeeinsatz haben. Kunden in Pause werden nicht angezeigt.</span>
                    </span>
                </div>
                <div class="widget-content" id="active-customers-now-widget">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Daten werden geladen...</div>
                    </div>
                </div> 
            </div>
            
            <div class="widget">
                <div class="widget-header">Abschlussquote (letzte 30 Tage)
                    <span class="info-icon">i
                        <span class="tooltip">Anteil der Neuverträge im Verhältnis zu Netto-Leads der letzten 30 Tage.</span>
                    </span>
                </div>
                <div class="widget-content" id="conversion-rate-widget">
                    <div class="customer-count">0%</div>
                </div>
            </div>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Tagesverdienst (Provisionen)
                    <span class="info-icon">i
                        <span class="tooltip">Deine durchschnittlichen täglichen Provisionseinnahmen</span>
                    </span>
                </div>
                <div class="widget-content">
                    <div class="customer-count" id="total-revenue">0 €</div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-header">Neue Verträge (letzte 14 Tage)
                    <span class="info-icon">i
                        <span class="tooltip">Anzahl der neuen Verträge und Agenturwechsel in den letzten 14 Tagen.</span>
                    </span>
                </div>
                <div class="widget-content" id="new-contracts-widget">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Daten werden geladen...</div>
                    </div>
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="new-contracts">0</div>
                            <div class="metric-label">Neu</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="agency-switches">0</div>
                            <div class="metric-label">Agenturwechsel</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">davon noch aktiv
                    <span class="info-icon">i
                        <span class="tooltip">Anzahl der neuen Verträge und Agenturwechsel, die noch aktiv sind.</span>
                    </span>
                </div>
                <div class="widget-content" id="active-contracts-widget">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Daten werden geladen...</div>
                    </div>
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="active-new-contracts">0</div>
                            <div class="metric-label">Neu</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="active-agency-switches">0</div>
                            <div class="metric-label">Agenturwechsel</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-header">Kündigungen
                    <span class="info-icon">i
                        <span class="tooltip">Anzahl der Kündigungen, aufgeteilt nach ernsthaften Kündigungen und (nur) Agenturwechseln.</span>
                    </span>
                </div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="serious-terminations">0</div>
                            <div class="metric-label">Ernst</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="agency-change-terminations">0</div>
                            <div class="metric-label">Agenturwechsel</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="kpi-tab" class="tab-content">
        

        <!-- NEU: Datumsauswahl für KPIs -->
        <div class="date-range-selector" style="margin-bottom: 15px; border-bottom: 1px solid rgba(0, 255, 255, 0.1); padding-bottom: 15px;">
            <label for="kpi-start-date" style="margin-right: 5px; color: #e0e0e0;">Von:</label>
            <input type="date" class="date-input" id="kpi-start-date">
            <label for="kpi-end-date" style="margin-left: 15px; margin-right: 5px; color: #e0e0e0;">Bis:</label>
            <input type="date" class="date-input" id="kpi-end-date">
            <button class="date-range-button" id="update-kpi-range-btn" style="margin-left: 15px;">Aktualisieren</button>
        </div>
        
        <!-- KPI-Karten im Grid-Layout -->
        <div class="kpi-grid">
            <!-- 2. Abschlussquote (alle Leads) - JETZT ZUERST -->
            <div class="widget gauge-card">
                <div class="widget-header">
                    Abschlussquote (alle Leads)
                    <span class="info-icon">i
                        <span class="tooltip">Prozentualer Anteil der Neuverträge im Verhältnis zu Netto-Leads. Berücksichtigt nur echte Neuverträge (ohne Agenturwechsel).</span>
                    </span>
                </div>
                <div class="widget-content">
                    <div class="gauge-container" id="gauge-closing-rate"></div>
                    <div class="gauge-value-percent" id="closing-rate-percent">0%</div>
                    <div class="gauge-value-absolute" id="closing-rate-absolute">0 / 0</div>
                </div>
            </div>

            <!-- 1. Lead zu EB Conversion - JETZT ZWEITE -->
            <div class="widget gauge-card">
                <div class="widget-header">
                    Lead zu EB Conversion
                    <span class="info-icon">i
                        <span class="tooltip">Prozentualer Anteil der Erfassungsbögen (EB) im Verhältnis zu Leads.</span>
                    </span>
                </div>
                <div class="widget-content">
                    <div class="gauge-container" id="gauge-lead-eb"></div>
                    <div class="gauge-value-percent" id="lead-eb-percent">0%</div>
                    <div class="gauge-value-absolute" id="lead-eb-absolute">0/0</div>
                </div>
            </div>
            
            <!-- 3. EB zu Posting Conversion -->
            <div class="widget gauge-card">
                <div class="widget-header">
                    EB zu Posting Conversion
                    <span class="info-icon">i
                        <span class="tooltip">Prozentualer Anteil der Postings im Verhältnis zu Erfassungsbögen (EB).</span>
                    </span>
                </div>
                <div class="widget-content">
                    <div class="gauge-container" id="gauge-eb-posting"></div>
                    <div class="gauge-value-percent" id="eb-posting-percent">0%</div>
                    <div class="gauge-value-absolute" id="eb-posting-absolute">0/0</div>
                </div>
            </div>
            
            <!-- 4. Abschlussquote (Leads aus Zeitraum) -->
            <div class="widget gauge-card">
                <div class="widget-header">
                    Abschlussquote (Leads aus Zeitraum)
                    <span class="info-icon">i
                        <span class="tooltip">Prozentualer Anteil erfolgreicher Leads im Verhältnis zu gekauften Leads. Berücksichtigt nur echte Neuverträge (ohne Agenturwechsel).</span>
                    </span>
                </div>
                <div class="widget-content">
                    <div class="gauge-container" id="gauge-lead-quality"></div>
                    <div class="gauge-value-percent" id="lead-quality-percent">0%</div>
                    <div class="gauge-value-absolute" id="lead-quality-absolute">0 / 0</div>
                </div>
            </div>
            
            <!-- 5. Posting zu Vertrag Conversion -->
            <div class="widget gauge-card">
                <div class="widget-header">
                    Posting zu Vertrag Conversion
                    <span class="info-icon">i
                        <span class="tooltip">Prozentualer Anteil neuer Verträge im Verhältnis zu Postings (ohne Agenturwechsel).</span>
                    </span>
                </div>
                <div class="widget-content">
                    <div class="gauge-container" id="gauge-posting-contract"></div>
                    <div class="gauge-value-percent" id="posting-contract-percent">0%</div>
                    <div class="gauge-value-absolute" id="posting-contract-absolute">0/0</div>
                </div>
            </div>
            
            <!-- 6. Kündigungsquote -->
            <div class="widget gauge-card">
                <div class="widget-header">
                    Kündigungsquote
                    <span class="info-icon">i
                        <span class="tooltip">Prozentualer Anteil der Kündigungen im Verhältnis zu aktiven Kunden.</span>
                    </span>
                </div>
                <div class="widget-content">
                    <div class="gauge-container" id="gauge-termination-rate"></div>
                    <div class="gauge-value-percent" id="termination-rate-percent">0%</div>
                    <div class="gauge-value-absolute" id="termination-rate-absolute">0/0</div>
                </div>
            </div>
        </div>

    </div>

    <div id="customers-tab" class="tab-content">
        <div class="widget-row">
            <div class="wide-widget">
                <div class="widget-header">Aktive Kunden: <span id="active-customers-count">0</span>
                    <span class="info-icon">i
                        <span class="tooltip">Liste aller aktiven Kunden mit ihren Agenturen und dem laufenden Pflegeeinsatz.</span>
                    </span>
                </div>
                <div class="widget-content">
                    <div id="active-customers-list-container">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <div>Kundendaten werden geladen...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="widget-row">
            <div class="wide-widget">
                <div class="widget-header">Kunden in Pause: <span id="paused-customers-count">0</span>
                    <span class="info-icon">i
                        <span class="tooltip">Liste aller Kunden, deren Verträge derzeit pausiert sind, mit Angabe der Pausierungsdauer.</span>
                    </span>
                </div>
                <div class="widget-content">
                    <div id="paused-customers-container" class="text-center">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <div>Lade Kunden in Pause...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hinzugefügte CSS-Stile für KPI Gauges -->
<style>
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Responsive Grid */
    gap: 20px; /* Abstand zwischen den Karten */
}

.gauge-card .widget-content {
    display: flex;
    flex-direction: column;
    align-items: center; /* Zentriert den Inhalt horizontal */
    justify-content: space-between; /* Verteilt Platz vertikal */
    padding: 15px;
    height: 180px; /* Etwas kürzere Höhe */
    text-align: center;
}

/* SEHR EINFACHER GAUGE STIL */
.gauge-container {
    width: 100%;
    height: 30px;
    margin: 15px 0;
    position: relative;
    display: table; /* Tabellen-Display für maximale Kompatibilität */
    border-collapse: collapse;
}

.simple-progress {
    height: 30px;
    display: table-cell; /* Zelle für linke Seite */
    background-color: #00FFAA; /* Sehr helle Farbe */
    color: black; /* Schwarzer Text für Kontrast */
    text-align: center;
    vertical-align: middle;
    font-weight: bold;
    border-right: 1px solid #000;
}

.simple-rest {
    height: 30px;
    display: table-cell; /* Zelle für rechte Seite */
    background-color: #333; /* Dunkelgrau */
    border-left: 1px solid #000; 
}

.gauge-value-percent {
    font-size: 2.2em;
    font-weight: bold;
    color: #00ffff;
    margin-bottom: 15px;
}

.gauge-value-absolute {
    font-size: 0.9em;
    color: #a0a0a0;
}

/* Zusätzliche Debug-Klasse */
.debug-border {
    border: 2px solid red !important;
}
</style>

<!-- Inline-JavaScript direkt im Overlay -->
<script>
    (function() {
        console.log('My Business Overlay: JavaScript wird initialisiert');
        
        // --- ABSOLUT NEUER FORTSCHRITTSBALKEN ANSATZ ---
        function createGauge(elementId, percentage) {
            const container = document.getElementById(elementId);
            if (!container) {
                console.error(`Container ${elementId} nicht gefunden`);
                return;
            }
            
            let value = parseFloat(percentage);
            if (isNaN(value) || value < 0) value = 0;
            if (value > 100) value = 100;
            
            // EXTREM einfache 2-Zellen-Tabelle erstellen
            // Keine CSS-Abhängigkeiten, funktioniert in jedem Browser
            container.innerHTML = `
                <table cellspacing="0" cellpadding="0" border="0" style="width:100%; height:30px; border-collapse:collapse; background:#333;">
                    <tr>
                        <td width="${value}%" style="background:#00FFAA; text-align:center; color:#000; font-weight:bold; font-size:14px;">${value}%</td>
                        <td width="${100-value}%"></td>
                    </tr>
                </table>
            `;
            
            console.log(`Fortschrittsbalken für ${elementId} mit ${value}% erstellt (HTML-Tabelle)`);
        }

        function loadAndDisplayKpiData(startDate = null, endDate = null) {
            console.log('Lade KPI-Daten für Zeitraum:', startDate, 'bis', endDate);

            // Setze Ladezustand für alle KPI-Karten
            const kpiValueElements = document.querySelectorAll('.gauge-value-percent, .gauge-value-absolute');
            kpiValueElements.forEach(el => el.textContent = '...');
            const gaugeContainers = document.querySelectorAll('.gauge-container');
            gaugeContainers.forEach(el => {
                el.innerHTML = '<div class="spinner-small"></div>';
                el.classList.add('debug-border'); // DEBUG: Visuell markieren
            });

            // Korrigierte URL: /get_kpi_data verwenden
            let url = '/get_kpi_data';
            if (startDate && endDate) {
                url += `?start_date=${startDate}&end_date=${endDate}`;
            } else {
                 url += '?t=' + new Date().getTime(); // Cache-Buster
                 console.warn('KPI-Daten ohne Zeitraum angefragt.');
            }
            // Cache-Buster immer anhängen
            url += (url.includes('?') ? '&' : '?') + 't=' + new Date().getTime(); 

            fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Cache-Control': 'no-cache'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('KPI-Daten erhalten:', data);
                // Anpassung: Die Daten kommen direkt im Root-Objekt, nicht unter data.kpis
                if (data) {
                    const kpis = data; // Daten direkt verwenden

                    // Helper zum Aktualisieren einer KPI-Karte
                    const updateGaugeCard = (baseId, percent, absolute) => {
                        console.log(`UPDATE: ${baseId} - Prozent: ${percent}, Absolut: ${absolute}`);
                        
                        // DOM-Elemente finden
                        const percentEl = document.getElementById(`${baseId}-percent`);
                        const absoluteEl = document.getElementById(`${baseId}-absolute`);
                        const gaugeContainerId = `gauge-${baseId.replace(/-/g, '-')}`;
                        
                        // Prozentwert aktualisieren
                        if (percentEl) {
                            percentEl.textContent = `${percent}%`;
                            console.log(`${baseId} Prozent-Element aktualisiert`);
                        } else {
                            console.error(`${baseId} Prozent-Element nicht gefunden!`);
                        }
                        
                        // Absoluten Wert aktualisieren
                        if (absoluteEl) {
                            absoluteEl.textContent = absolute;
                            console.log(`${baseId} Absolut-Element aktualisiert`);
                        } else {
                            console.error(`${baseId} Absolut-Element nicht gefunden!`);
                        }
                        
                        // Gauge aktualisieren
                        createGauge(gaugeContainerId, percent);
                    };

                    // Update each KPI card
                    updateGaugeCard('lead-eb', kpis.lead_to_eb_conversion?.percentage || 0, kpis.lead_to_eb_conversion?.absolute || '0/0');
                    updateGaugeCard('closing-rate', kpis.closing_rate?.percentage || 0, kpis.closing_rate?.absolute || '0/0');
                    updateGaugeCard('eb-posting', kpis.eb_to_posting_conversion?.percentage || 0, kpis.eb_to_posting_conversion?.absolute || '0/0');
                    updateGaugeCard('lead-quality', kpis.lead_quality_rate?.percentage || 0, kpis.lead_quality_rate?.absolute || '0/0');
                    updateGaugeCard('posting-contract', kpis.posting_to_contract_conversion?.percentage || 0, kpis.posting_to_contract_conversion?.absolute || '0/0');
                    updateGaugeCard('termination-rate', kpis.termination_rate?.percentage || 0, kpis.termination_rate?.absolute || '0/0');
                    
                    // LETZTER VERSUCH: Direkte DOM-Manipulation nach einem kurzen Timeout
                    setTimeout(() => {
                        document.querySelectorAll('.gauge-container').forEach(container => {
                            const fill = container.querySelector('.gauge-fill');
                            const valueEl = container.parentNode.querySelector('.gauge-value-percent');
                            
                            if (fill && valueEl) {
                                const percent = parseFloat(valueEl.textContent);
                                if (!isNaN(percent)) {
                                    fill.style.width = `${percent}%`;
                                    console.log(`TIMEOUT KORREKTUR: ${container.id} Breite auf ${percent}% gesetzt`);
                                }
                            }
                        });
                    }, 200);
                    
                } else {
                    console.error('Keine KPI-Daten im Response enthalten.');
                    showErrorMessage('Keine KPI-Daten erhalten.');
                }
            })
            .catch(error => {
                console.error('Fehler beim Laden der KPI-Daten:', error);
                showErrorMessage('Fehler beim Laden der KPIs: ' + error.message);
                 // Reset Gauges on error
                 gaugeContainers.forEach(el => el.innerHTML = '<div style="color:red; font-size:0.8em;">Fehler</div>');
                 kpiValueElements.forEach(el => el.textContent = '-');
            });
        }

        // Element-Referenzen
        const activeCustomersNowWidget = document.getElementById('active-customers-now-widget');
        const activeCustomersListContainer = document.getElementById('active-customers-list-container');
        
        console.log('Active Customers Widget gefunden:', activeCustomersNowWidget !== null);
        console.log('Active Customers List Container gefunden:', activeCustomersListContainer !== null);
        
        // Sofort Daten laden, wenn das Overlay geöffnet wird
        setTimeout(loadDashboardDataDirectly, 500);
        
        // Funktion zum direkten Laden der Dashboard-Daten
        function loadDashboardDataDirectly() {
            console.log('Direktes Laden der Dashboard-Daten wird gestartet');
            
            // Loading-Status anzeigen
            if (activeCustomersNowWidget) {
                activeCustomersNowWidget.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Direktes Laden...</div>
                    </div>
                `;
            }
            
            if (activeCustomersListContainer) {
                activeCustomersListContainer.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Direktes Laden der Kundendaten...</div>
                    </div>
                `;
            }
            
            // Weitere Widgets mit Ladeanzeige aktualisieren
            document.getElementById('conversion-rate-widget').innerHTML = '<div class="loading-spinner"><div class="spinner"></div><div>Laden...</div></div>';
            setElementText('new-contracts', '...');
            setElementText('agency-switches', '...');
            setElementText('serious-terminations', '...');
            setElementText('agency-change-terminations', '...');
            setElementText('active-new-contracts', '...');
            setElementText('active-agency-switches', '...');
            
            // Direkte XHR-Anfrage
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/get_dashboard_data', true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.setRequestHeader('Cache-Control', 'no-cache, no-store, must-revalidate');
            
            xhr.onreadystatechange = function() {
                if (this.readyState === 4) {
                    console.log('XHR Status:', this.status);
                    console.log('XHR Response Anfang:', this.responseText.substring(0, 100));
                    
                    if (this.status === 200) {
                        try {
                            const data = JSON.parse(this.responseText);
                            console.log('Dashboard-Daten erfolgreich geladen:', data);
                            
                            // Kundenzahl aktualisieren
                            if (activeCustomersNowWidget) {
                                activeCustomersNowWidget.innerHTML = `
                                    <div class="customer-count">${data.count || 0}</div>
                                `;
                                console.log('Kundenzahl aktualisiert:', data.count);
                            }
                            
                            // Kundenliste aktualisieren
                            updateCustomerList(data.data);
                            
                            // Gesamtumsatz Pro Rata (NEUE METHODE)
                            const totalRevenueElementNew = document.getElementById('total-revenue');
                            if (totalRevenueElementNew && data.pro_rata_revenue !== undefined) {
                                const proRataRevenue = parseFloat(data.pro_rata_revenue) || 0;
                                
                                // Berechne täglichen Durchschnittsverdienst
                                // Aktuelle Anzahl Tage im Monat
                                const now = new Date();
                                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                                const currentDay = Math.min(now.getDate(), daysInMonth);
                                
                                // Täglicher Durchschnitt (Annahme: Umsatz ist pro Monat)
                                const dailyAverage = proRataRevenue / currentDay;
                                
                                // Anzeigen mit 2 Dezimalstellen
                                totalRevenueElementNew.textContent = `${dailyAverage.toFixed(2)} €`;
                                console.log('Täglicher Provisionsertrag berechnet:', dailyAverage.toFixed(2), '€ (Monatsumsatz:', proRataRevenue.toFixed(2), '€ geteilt durch', currentDay, 'Tage)');
                            } else if (totalRevenueElementNew) {
                                // Fallback, falls Wert nicht vorhanden
                                totalRevenueElementNew.textContent = '0.00 €';
                                console.log('Täglicher Provisionsertrag konnte nicht berechnet werden, keine Umsatzdaten verfügbar');
                            }
                            
                            // Abschlussquote aktualisieren
                            const conversionRateWidget = document.getElementById('conversion-rate-widget');
                            if (conversionRateWidget && data.conversion_rate) {
                                const rate = data.conversion_rate.conversion_rate || 0;
                                conversionRateWidget.innerHTML = `<div class="customer-count">${rate}%</div>`;
                                console.log('Abschlussquote aktualisiert:', rate);
                            } else if (conversionRateWidget) {
                                conversionRateWidget.innerHTML = `<div class="customer-count">0%</div>`;
                            }
                            
                            // Neue Verträge aktualisieren
                            if (data.new_contracts) {
                                // Spinner entfernen
                                hideLoadingSpinner('new-contracts-widget');
                                
                                // Echte neue Verträge
                                const newContractsCount = data.new_contracts.normal_contracts_count || 0;
                                setElementText('new-contracts', newContractsCount);
                                
                                                // Agenturwechsel
                                const agencyChangesCount = data.new_contracts.agency_change_contracts_count || 0;
                                setElementText('agency-switches', agencyChangesCount);
                                
                                console.log('Neue Verträge aktualisiert:', newContractsCount, 'neu,', agencyChangesCount, 'Agenturwechsel');
                                
                                // Lade Kunden in Pause
                                loadPausedCustomers();
                            }
                            
                            // Aktive neue Verträge aktualisieren
                            if (data.active_new_contracts || data.new_contracts) {
                                const activeData = data.active_new_contracts ? data.active_new_contracts : data.new_contracts;
                                // Spinner entfernen
                                hideLoadingSpinner('active-contracts-widget');
                                
                                // Echte neue Verträge
                                const activeNewContractsCount = activeData.normal_contracts_count || 0;
                                setElementText('active-new-contracts', activeNewContractsCount);
                                
                                // Agenturwechsel
                                const activeAgencyChangesCount = activeData.agency_change_contracts_count || 0;
                                setElementText('active-agency-switches', activeAgencyChangesCount);
                                
                                console.log('Aktive neue Verträge aktualisiert:', activeNewContractsCount, 'neu,', activeAgencyChangesCount, 'Agenturwechsel');
                            }
                            
                            // Kündigungen aktualisieren
                            if (data.terminations) {
                                // Ernsthafte Kündigungen
                                const seriousTerminations = data.terminations.serious_terminations_count || 0;
                                setElementText('serious-terminations', seriousTerminations);
                                
                                // Agenturwechsel
                                const agencyChangeTerminations = data.terminations.agency_switch_count || 0;
                                setElementText('agency-change-terminations', agencyChangeTerminations);
                                
                                console.log('Kündigungen aktualisiert:', seriousTerminations, 'ernsthaft,', agencyChangeTerminations, 'Agenturwechsel');
                            }
                            
                        } catch (e) {
                            console.error('Fehler beim Parsen der JSON-Antwort:', e);
                            showErrorMessage('Fehler beim Parsen der Daten: ' + e.message);
                        }
                    } else {
                        console.error('XHR-Fehler:', this.status);
                        showErrorMessage('Server-Fehler: ' + this.status);
                    }
                }
            };
            
            xhr.onerror = function() {
                console.error('Netzwerkfehler bei der XHR-Anfrage');
                showErrorMessage('Netzwerkfehler bei der Anfrage');
            };
            
            xhr.send();
            console.log('XHR-Anfrage gesendet');
        }
        
        // Hilfsfunktion zur Textaktualisierung von Elementen
        function setElementText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            } else {
                console.warn(`Element mit ID ${elementId} nicht gefunden`);
            }
        }
        
        // Hilfsfunktion zum Ausblenden des Loading-Spinners
        function hideLoadingSpinner(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                const spinner = container.querySelector('.loading-spinner');
                if (spinner) {
                    spinner.style.display = 'none';
                }
            } else {
                console.warn(`Container mit ID ${containerId} nicht gefunden`);
            }
        }
        
        // Hilfsfunktion zur Fehleranzeige
        function showErrorMessage(message) {
            const errorHtml = `
                <div class="error-message">
                    <div>Fehler</div>
                    <div class="error-details">${message}</div>
                </div>
            `;
            
            if (activeCustomersNowWidget) {
                activeCustomersNowWidget.innerHTML = errorHtml;
            }
            
            if (activeCustomersListContainer) {
                activeCustomersListContainer.innerHTML = errorHtml;
            }
        }
        
        // Hilfsfunktion zum Formatieren des Datums
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            if (isNaN(date)) return '';
            
            return date.toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        // Hilfsfunktion zum Abrufen des CSRF-Tokens
        function getCsrfToken() {
            const metaElement = document.querySelector('meta[name="csrf-token"]');
            return metaElement ? metaElement.getAttribute('content') : '';
        }
        
        // Funktion zum Laden der Kunden in Pause
        function loadPausedCustomers() {
            console.log('Lade Kunden in Pause...');
            const pausedCustomersContainer = document.getElementById('paused-customers-container');
            const pausedCustomersCountContainer = document.getElementById('paused-customers-count-container');
            const pausedCustomersCount = document.getElementById('paused-customers-count');
            
            // Lade-Indikator anzeigen
            if (pausedCustomersContainer) {
                pausedCustomersContainer.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Lade Kunden in Pause...</div>
                    </div>
                `;
            }
            
            // Verwende XHR für konsistente Request-Verarbeitung (wie bei loadDashboardDataDirectly)
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/get_dashboard_data?type=paused_customers&t=' + new Date().getTime(), true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.setRequestHeader('Cache-Control', 'no-cache, no-store, must-revalidate');
            
            xhr.onreadystatechange = function() {
                if (this.readyState === 4) {
                    console.log('Kunden in Pause - XHR Status:', this.status);
                    
                    if (this.status === 200) {
                        try {
                            const data = JSON.parse(this.responseText);
                            console.log('Kunden in Pause - Daten erfolgreich geladen:', data);
                            
                            if (data && data.paused_customers) {
                                const pausedCustomers = data.paused_customers.data || [];
                                console.log('Pausierte Kunden Daten:', pausedCustomers);
                                console.log('Pausierte Kunden Struktur:', data.paused_customers);
                                
                                // Direkt die count-Eigenschaft aus der Server-Antwort auslesen
                                let pausedCount = data.paused_customers.count || 0;
                                console.log('Server-Seitige Zählung (count):', pausedCount);
                                
                                // Alternative Felder prüfen
                                if (data.paused_customers.total_count !== undefined) {
                                    console.log('Server-Seitige Gesamtzahl (total_count):', data.paused_customers.total_count);
                                    pausedCount = data.paused_customers.total_count;
                                }
                                
                                // Als Fallback total_paused_customers aus dem ersten Datensatz prüfen
                                if (pausedCount === 0 && pausedCustomers.length > 0 && pausedCustomers[0].total_paused_customers) {
                                    console.log('Verwende total_paused_customers aus Datensatz:', pausedCustomers[0].total_paused_customers);
                                    try {
                                        pausedCount = parseInt(pausedCustomers[0].total_paused_customers, 10);
                                    } catch (e) {
                                        console.error('Fehler beim Konvertieren von total_paused_customers:', e);
                                    }
                                }
                                
                                // Zeige die Gesamtzahl an - jetzt im Count-Container
                                if (pausedCustomersCountContainer) {
                                    pausedCustomersCountContainer.innerHTML = `<div class="customer-count">${pausedCount}</div>`;
                                }
                                
                                // Auch im Header anzeigen
                                if (pausedCustomersCount) {
                                    pausedCustomersCount.textContent = pausedCount;
                                }
                                
                                console.log(`${pausedCount} Kunden sind in Pause`);
                                
                                // Fülle die Kundenliste mit den Kunden in Pause
                                if (pausedCustomers.length > 0) {
                                    let listHtml = '<div class="customer-list">';
                                    
                                    pausedCustomers.forEach(customer => {
                                        const name = `${customer.first_name || ''} ${customer.last_name || ''}`.trim();
                                        const daysOnPause = customer.days_on_pause || '?';
                                        const agency = customer.agency_name || 'Keine Agentur';
                                        
                                        // Neues Format wie bei aktiven Kunden
                                        listHtml += `
                                            <div class="customer-item">
                                                <div class="customer-name">${name}</div>
                                                <div class="customer-agency">${agency}</div>
                                                <div class="customer-since">${daysOnPause} Tage in Pause</div>
                                            </div>
                                        `;
                                    });
                                    
                                    listHtml += '</div>';
                                    
                                    // WICHTIG: Ersetze den gesamten Container mit der Kundenliste
                                    if (pausedCustomersContainer) {
                                        pausedCustomersContainer.innerHTML = listHtml;
                                    }
                                    
                                } else {
                                    // Wenn keine Kundendaten vorhanden sind, aber pausedCount > 0 ist
                                    let message = '';
                                    if (pausedCount > 0) {
                                        message = '<div class="text-center p-3">Es gibt Kunden in Pause, aber keine detaillierten Daten verfügbar.</div>';
                                    } else {
                                        message = '<div class="text-center p-3">Keine Kunden in Pause gefunden</div>';
                                    }
                                    
                                    // Ersetze den gesamten Container mit der Meldung
                                    if (pausedCustomersContainer) {
                                        pausedCustomersContainer.innerHTML = message;
                                    }
                                }
                            } else {
                                if (pausedCustomersCountContainer) {
                                    pausedCustomersCountContainer.innerHTML = `<div class="customer-count">0</div>`;
                                }
                                
                                // Auch im Header aktualisieren
                                if (pausedCustomersCount) {
                                    pausedCustomersCount.textContent = '0';
                                }
                                
                                const noDataMessage = '<div class="text-center p-2">Keine Daten zu Kunden in Pause gefunden</div>';
                                
                                if (pausedCustomersContainer) {
                                    pausedCustomersContainer.innerHTML = noDataMessage;
                                }
                                
                                console.log('Keine Daten für Kunden in Pause gefunden');
                            }
                        } catch (e) {
                            console.error('Fehler beim Parsen der JSON-Antwort:', e);
                            if (pausedCustomersCountContainer) {
                                pausedCustomersCountContainer.innerHTML = `<div class="customer-count">?</div>`;
                            }
                            
                            // Auch im Header aktualisieren
                            if (pausedCustomersCount) {
                                pausedCustomersCount.textContent = '?';
                            }
                            
                            const errorMessage = '<div class="text-center p-2 text-danger">Fehler beim Laden der Daten</div>';
                            
                            if (pausedCustomersContainer) {
                                pausedCustomersContainer.innerHTML = errorMessage;
                            }
                        }
                    } else {
                        console.error('Fehler beim Laden der Kunden in Pause. Status:', this.status);
                        if (pausedCustomersContainer) {
                            pausedCustomersContainer.innerHTML = `<div class="customer-count">-</div>`;
                        }
                        
                        // Auch im Header aktualisieren
                        if (pausedCustomersCount) {
                            pausedCustomersCount.textContent = '-';
                        }
                    }
                }
            };
            
            xhr.onerror = function() {
                console.error('Netzwerkfehler beim Laden der Kunden in Pause');
                if (pausedCustomersContainer) {
                    pausedCustomersContainer.innerHTML = `<div class="customer-count">-</div>`;
                }
                
                // Auch im Header aktualisieren
                if (pausedCustomersCount) {
                    pausedCustomersCount.textContent = '-';
                }
            };
            
            xhr.send();
        }
        
        // Funktion zum Aktualisieren der Kundenliste
        function updateCustomerList(customers) {
            if (activeCustomersListContainer && customers && customers.length > 0) {
                let customersHtml = '<div class="customer-list">';
                
                // Map um Kunden nach Namen zu gruppieren und Duplikate zu identifizieren
                const customerMap = new Map();
                
                // Jedes Kundendatenobjekt durchgehen
                customers.forEach(function(customer) {
                    // Eindeutigen Schlüssel für jeden Kunden erstellen
                    const customerKey = `${customer.first_name || ''} ${customer.last_name || ''}`.trim().toLowerCase();
                    
                    // Wenn der Kunde noch nicht in der Map ist, fügen wir ihn hinzu
                    if (!customerMap.has(customerKey)) {
                        customerMap.set(customerKey, {
                            customer: customer,
                            count: 1 // Zähle, wie viele Care Stays dieser Kunde hat
                        });
                    } else {
                        // Wenn der Kunde bereits existiert, erhöhe den Zähler
                        const existingData = customerMap.get(customerKey);
                        existingData.count += 1;
                        customerMap.set(customerKey, existingData);
                    }
                });
                
                // CSS-Styles für das Warndreieck
                const styles = `
                    <style>
                        .warning-triangle {
                            color: #ff4040;
                            margin-left: 5px;
                            font-size: 16px;
                            position: relative;
                            cursor: help;
                        }
                        .warning-triangle:hover::after {
                            content: attr(data-title);
                            position: absolute;
                            background: rgba(0, 0, 0, 0.8);
                            color: white;
                            border-radius: 4px;
                            padding: 5px 10px;
                            font-size: 12px;
                            width: 200px;
                            left: 20px;
                            top: -5px;
                            z-index: 100;
                            font-weight: normal;
                        }
                    </style>
                `;
                customersHtml += styles;
                
                // Erstelle einen Eintrag für jeden eindeutigen Kunden
                customerMap.forEach(function(data) {
                    const customer = data.customer;
                    const careStayCount = data.count;
                    
                    // Warndreieck für mehrere Care Stays hinzufügen
                    const warningIcon = careStayCount > 1 
                        ? `<span class="warning-triangle" data-title="Kunde hat ${careStayCount} aktive Pflegeeinsätze gleichzeitig, wird aber nur einmal gezählt">⚠</span>` 
                        : '';
                    
                    customersHtml += `
                        <div class="customer-item">
                            <div class="customer-name">${customer.first_name || ''} ${customer.last_name || ''} ${warningIcon}</div>
                            <div class="customer-agency">${customer.agency_name || 'Keine Agentur'}</div>
                            <div class="customer-since">${formatDate(customer.bill_start) || 'unbekannt'} - ${formatDate(customer.bill_end) || 'laufend'}</div>
                        </div>
                    `;
                });
                
                customersHtml += '</div>';
                activeCustomersListContainer.innerHTML = customersHtml;
                
                // Zähle die tatsächlichen eindeutigen Kunden
                const uniqueCustomerCount = customerMap.size;
                console.log('Kundenliste aktualisiert mit', uniqueCustomerCount, 'eindeutigen Kunden von insgesamt', customers.length, 'Care Stays');
                
                // Update the customer count to reflect the unique customers
                if (activeCustomersNowWidget) {
                    activeCustomersNowWidget.innerHTML = `<div class="customer-count">${uniqueCustomerCount}</div>`;
                    console.log('Kundenzahl korrigiert auf eindeutige Kunden:', uniqueCustomerCount);
                }
                
                // Aktualisiere die Anzahl im Header
                const activeCustomersCount = document.getElementById('active-customers-count');
                if (activeCustomersCount) {
                    activeCustomersCount.textContent = uniqueCustomerCount;
                }
            } else {
                activeCustomersListContainer.innerHTML = '<div class="empty-message">Keine aktiven Kunden gefunden</div>';
                
                // Zeige 0 im Header an, wenn keine Kunden vorhanden sind
                const activeCustomersCount = document.getElementById('active-customers-count');
                if (activeCustomersCount) {
                    activeCustomersCount.textContent = '0';
                }
            }
        }

        // CSS für die neuen Navigationsbuttons
        const styleElement = document.createElement('style');
        styleElement.textContent = `
            .business-nav-buttons {
                display: flex;
                align-items: center;
                margin-left: auto;
            }
            
            .business-nav-btn {
                display: inline-block;
                padding: 8px 15px;
                margin-left: 10px;
                border-radius: 4px;
                text-decoration: none;
                font-size: 14px;
                font-weight: 500;
                transition: all 0.2s ease;
                cursor: pointer;
            }
            
            .chat-toggle-btn {
                background-color: #2196F3;
                color: white;
                border: 1px solid #1976D2;
            }
            
            .chat-toggle-btn:hover {
                background-color: #1976D2;
            }
            
            .logout-btn {
                background-color: rgba(255, 60, 60, 0.1);
                color: #ff3c3c;
                border: 1px solid rgba(255, 60, 60, 0.3);
            }
            
            .logout-btn:hover {
                background-color: rgba(255, 60, 60, 0.2);
            }
            
            .business-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }
        `;
        document.head.appendChild(styleElement);
        
        // Chat-Button-Funktionalität hinzufügen
        const toggleChatBtn = document.getElementById('toggleChatBtn');
        if (toggleChatBtn) {
            toggleChatBtn.addEventListener('click', function() {
                // Prüfen, ob das chatOverlay-Element existiert
                const chatOverlay = document.getElementById('chatOverlay');
                if (chatOverlay) {
                    // Chat-Overlay anzeigen
                    chatOverlay.style.display = 'flex';
                    
                    // Scrolle den Chat-Verlauf nach unten, falls nötig
                    const chatHistory = document.getElementById('chatHistory');
                    if (chatHistory) {
                        chatHistory.scrollTop = chatHistory.scrollHeight;
                    }
                    
                    console.log('Chat-Overlay wurde angezeigt');
                } else {
                    // Fallback: Zur Hauptseite navigieren
                    console.log('Chat-Overlay nicht gefunden, navigiere zur Hauptseite');
                    window.location.href = '/';
                }
            });
            console.log('Event-Listener für toggleChatBtn hinzugefügt');
        } else {
            console.error('toggleChatBtn nicht gefunden!');
        }
        
        // Den Float-Button mit dem 💬 Symbol ausblenden
        const openChatBtn = document.getElementById('openChatBtn');
        if (openChatBtn) {
            openChatBtn.style.display = 'none';
        }

        // Event Listener für Tabs
        const businessTabs = document.querySelectorAll('.business-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        businessTabs.forEach(tab => {
            // ... event listener code as before ...
        });
        
        // Event Listener für KPI Datumsbereich-Button
        const updateKpiRangeBtn = document.getElementById('update-kpi-range-btn');
        if (updateKpiRangeBtn) {
            // ... event listener code as before ...
        }

    })(); // Hinzugefügte schließende Klammer für IIFE
</script>