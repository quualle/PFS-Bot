<div class="business-content">
    <div class="business-header">
        <h2>XORA - My PfS Assistant</h2>
        <button id="close-business-btn" class="close-business-btn">&times;</button>
    </div>

    <div class="business-tabs">
        <button class="business-tab active" data-tab="overview">Übersicht</button>
        <button class="business-tab" data-tab="kpi">Meine KPIs</button>
        <button class="business-tab" data-tab="customers">Meine Kunden</button>
        <button id="test-dashboard-btn" style="background: #ff5722; color: white; margin-left: 10px;">Test Laden</button>
    </div>

    <div id="overview-tab" class="tab-content active">
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Aktive Kunden (Heute)</div>
                <div class="widget-content" id="active-customers-now-widget">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Daten werden geladen...</div>
                    </div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-header">Abschlussquote (letzte 30 Tage)</div>
                <div class="widget-content" id="conversion-rate-widget">
                    <div class="customer-count">0%</div>
                </div>
            </div>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Umsatz</div>
                <div class="widget-content">
                    <div class="customer-count" id="total-revenue">0 €</div>
                    <div class="month-selector">
                        <select id="month-select" class="month-select">
                            <option value="0">Aktueller Monat</option>
                            <option value="1">Letzter Monat</option>
                            <option value="2">Vor 2 Monaten</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-header">Neue Verträge (letzte 14 Tage)</div>
                <div class="widget-content" id="new-contracts-widget">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Daten werden geladen...</div>
                    </div>
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="new-contracts">0</div>
                            <div class="metric-label">Neu</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="agency-switches">0</div>
                            <div class="metric-label">Agenturwechsel</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Neue Verträge (noch aktiv)</div>
                <div class="widget-content" id="active-contracts-widget">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Daten werden geladen...</div>
                    </div>
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="active-new-contracts">0</div>
                            <div class="metric-label">Neu</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="active-agency-switches">0</div>
                            <div class="metric-label">Agenturwechsel</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-header">Kündigungen</div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="serious-terminations">0</div>
                            <div class="metric-label">Ernst</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="agency-change-terminations">0</div>
                            <div class="metric-label">Agenturwechsel</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="kpi-tab" class="tab-content">
        <div class="date-range-selector" style="margin-bottom: 15px;">
            <input type="date" class="date-input" id="kpi-start-date">
            <input type="date" class="date-input" id="kpi-end-date">
            <button class="date-range-button" id="update-kpi-range-btn">Aktualisieren</button>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Abschlussquote (letzte 30 Tage)</div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="closing-rate-percent">0%</div>
                            <div class="metric-label">Prozentual</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="closing-rate-absolute">0/0</div>
                            <div class="metric-label">Absolut</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-header">Lead zu EB Conversion</div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="lead-eb-percent">0%</div>
                            <div class="metric-label">Prozentual</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="lead-eb-absolute">0/0</div>
                            <div class="metric-label">Absolut</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">EB zu Posting Conversion</div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="eb-posting-percent">0%</div>
                            <div class="metric-label">Prozentual</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="eb-posting-absolute">0/0</div>
                            <div class="metric-label">Absolut</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-header">Posting zu Vertrag Conversion</div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="posting-contract-percent">0%</div>
                            <div class="metric-label">Prozentual</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="posting-contract-absolute">0/0</div>
                            <div class="metric-label">Absolut</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Kündigungsquote</div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="termination-rate-percent">0%</div>
                            <div class="metric-label">Prozentual</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="termination-rate-absolute">0/0</div>
                            <div class="metric-label">Absolut</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="customers-tab" class="tab-content">
        <div class="widget-row">
            <div class="wide-widget">
                <div class="widget-header">Aktive Kunden</div>
                <div class="widget-content">
                    <div id="active-customers-list-container">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <div>Kundendaten werden geladen...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Neue Kunden (14 Tage)</div>
                <div class="widget-content" id="new-customers-container">
                    <div class="customer-count">0</div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-header">Kunden in Pause</div>
                <div class="widget-content" id="paused-customers-container">
                    <div class="customer-count">0</div>
                </div>
            </div>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Am längsten dabei</div>
                <div class="widget-content" id="longest-customers-container">
                    <div class="customer-count">0</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Inline-JavaScript direkt im Overlay -->
<script>
    // Sofort ausgeführtes JavaScript für das Overlay
    (function() {
        console.log('My Business Overlay: JavaScript wird initialisiert');
        
        // Element-Referenzen
        const testButton = document.getElementById('test-dashboard-btn');
        const activeCustomersNowWidget = document.getElementById('active-customers-now-widget');
        const activeCustomersListContainer = document.getElementById('active-customers-list-container');
        
        console.log('Test-Button gefunden:', testButton !== null);
        console.log('Active Customers Widget gefunden:', activeCustomersNowWidget !== null);
        console.log('Active Customers List Container gefunden:', activeCustomersListContainer !== null);
        
        // Handler für den Test-Button
        if (testButton) {
            testButton.addEventListener('click', function() {
                console.log('Test-Button wurde geklickt');
                loadDashboardDataDirectly();
            });
            console.log('Event-Handler für Test-Button wurde hinzugefügt');
        }
        
        // Sofort Daten laden, wenn das Overlay geöffnet wird
        setTimeout(loadDashboardDataDirectly, 500);
        
        // Funktion zum direkten Laden der Dashboard-Daten
        function loadDashboardDataDirectly() {
            console.log('Direktes Laden der Dashboard-Daten wird gestartet');
            
            // Loading-Status anzeigen
            if (activeCustomersNowWidget) {
                activeCustomersNowWidget.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Direktes Laden...</div>
                    </div>
                `;
            }
            
            if (activeCustomersListContainer) {
                activeCustomersListContainer.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Direktes Laden der Kundendaten...</div>
                    </div>
                `;
            }
            
            // Weitere Widgets mit Ladeanzeige aktualisieren
            document.getElementById('conversion-rate-widget').innerHTML = '<div class="loading-spinner"><div class="spinner"></div><div>Laden...</div></div>';
            setElementText('new-contracts', '...');
            setElementText('agency-switches', '...');
            setElementText('serious-terminations', '...');
            setElementText('agency-change-terminations', '...');
            setElementText('active-new-contracts', '...');
            setElementText('active-agency-switches', '...');
            
            // Direkte XHR-Anfrage
            const xhr = new XMLHttpRequest();
            const timestamp = new Date().getTime();
            xhr.open('GET', '/get_dashboard_data?t=' + timestamp, true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.setRequestHeader('Cache-Control', 'no-cache, no-store, must-revalidate');
            
            xhr.onreadystatechange = function() {
                if (this.readyState === 4) {
                    console.log('XHR Status:', this.status);
                    console.log('XHR Response Anfang:', this.responseText.substring(0, 100));
                    
                    if (this.status === 200) {
                        try {
                            const data = JSON.parse(this.responseText);
                            console.log('Dashboard-Daten erfolgreich geladen:', data);
                            
                            // Kundenzahl aktualisieren
                            if (activeCustomersNowWidget) {
                                activeCustomersNowWidget.innerHTML = `
                                    <div class="customer-count">${data.count || 0}</div>
                                `;
                                console.log('Kundenzahl aktualisiert:', data.count);
                            }
                            
                            // Kundenliste aktualisieren
                            updateCustomerList(data.data);
                            
                            // Gesamtumsatz Pro Rata (NEUE METHODE)
                            const totalRevenueElementNew = document.getElementById('total-revenue');
                            if (totalRevenueElementNew && data.pro_rata_revenue !== undefined) {
                                const proRataRevenue = parseFloat(data.pro_rata_revenue) || 0;
                                totalRevenueElementNew.textContent = `${proRataRevenue.toFixed(2)} €`;
                                console.log('Gesamtumsatz aktualisiert (Pro Rata Methode):', proRataRevenue.toFixed(2));
                            } else if (totalRevenueElementNew) {
                                // Fallback, falls Wert nicht vorhanden
                                totalRevenueElementNew.textContent = '0.00 €';
                                console.log('Gesamtumsatz Pro Rata konnte nicht geladen werden');
                            }
                            
                            // Abschlussquote aktualisieren
                            const conversionRateWidget = document.getElementById('conversion-rate-widget');
                            if (conversionRateWidget && data.conversion_rate) {
                                const rate = data.conversion_rate.conversion_rate || 0;
                                conversionRateWidget.innerHTML = `<div class="customer-count">${rate}%</div>`;
                                console.log('Abschlussquote aktualisiert:', rate);
                            } else if (conversionRateWidget) {
                                conversionRateWidget.innerHTML = `<div class="customer-count">0%</div>`;
                            }
                            
                            // Neue Verträge aktualisieren
                            if (data.new_contracts) {
                                // Spinner entfernen
                                hideLoadingSpinner('new-contracts-widget');
                                
                                // Echte neue Verträge
                                const newContractsCount = data.new_contracts.normal_contracts_count || 0;
                                setElementText('new-contracts', newContractsCount);
                                
                                // Agenturwechsel
                                const agencyChangesCount = data.new_contracts.agency_change_contracts_count || 0;
                                setElementText('agency-switches', agencyChangesCount);
                                
                                console.log('Neue Verträge aktualisiert:', newContractsCount, 'neu,', agencyChangesCount, 'Agenturwechsel');
                            }
                            
                            // Aktive neue Verträge aktualisieren
                            if (data.active_new_contracts || data.new_contracts) {
                                const activeData = data.active_new_contracts ? data.active_new_contracts : data.new_contracts;
                                // Spinner entfernen
                                hideLoadingSpinner('active-contracts-widget');
                                
                                // Echte neue Verträge
                                const activeNewContractsCount = activeData.normal_contracts_count || 0;
                                setElementText('active-new-contracts', activeNewContractsCount);
                                
                                // Agenturwechsel
                                const activeAgencyChangesCount = activeData.agency_change_contracts_count || 0;
                                setElementText('active-agency-switches', activeAgencyChangesCount);
                                
                                console.log('Aktive neue Verträge aktualisiert:', activeNewContractsCount, 'neu,', activeAgencyChangesCount, 'Agenturwechsel');
                            }
                            
                            // Kündigungen aktualisieren
                            if (data.terminations) {
                                // Ernsthafte Kündigungen
                                const seriousTerminations = data.terminations.serious_terminations_count || 0;
                                setElementText('serious-terminations', seriousTerminations);
                                
                                // Agenturwechsel
                                const agencyChangeTerminations = data.terminations.agency_switch_count || 0;
                                setElementText('agency-change-terminations', agencyChangeTerminations);
                                
                                console.log('Kündigungen aktualisiert:', seriousTerminations, 'ernsthaft,', agencyChangeTerminations, 'Agenturwechsel');
                            }
                            
                        } catch (e) {
                            console.error('Fehler beim Parsen der JSON-Antwort:', e);
                            showErrorMessage('Fehler beim Parsen der Daten: ' + e.message);
                        }
                    } else {
                        console.error('XHR-Fehler:', this.status);
                        showErrorMessage('Server-Fehler: ' + this.status);
                    }
                }
            };
            
            xhr.onerror = function() {
                console.error('Netzwerkfehler bei der XHR-Anfrage');
                showErrorMessage('Netzwerkfehler bei der Anfrage');
            };
            
            xhr.send();
            console.log('XHR-Anfrage gesendet');
        }
        
        // Hilfsfunktion zur Textaktualisierung von Elementen
        function setElementText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            } else {
                console.warn(`Element mit ID ${elementId} nicht gefunden`);
            }
        }
        
        // Hilfsfunktion zum Ausblenden des Loading-Spinners
        function hideLoadingSpinner(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                const spinner = container.querySelector('.loading-spinner');
                if (spinner) {
                    spinner.style.display = 'none';
                }
            } else {
                console.warn(`Container mit ID ${containerId} nicht gefunden`);
            }
        }
        
        // Hilfsfunktion zur Fehleranzeige
        function showErrorMessage(message) {
            const errorHtml = `
                <div class="error-message">
                    <div>Fehler</div>
                    <div class="error-details">${message}</div>
                </div>
            `;
            
            if (activeCustomersNowWidget) {
                activeCustomersNowWidget.innerHTML = errorHtml;
            }
            
            if (activeCustomersListContainer) {
                activeCustomersListContainer.innerHTML = errorHtml;
            }
        }
        
        // Hilfsfunktion zum Formatieren des Datums
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            if (isNaN(date)) return '';
            
            return date.toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        // Funktion zum Aktualisieren der Kundenliste
        function updateCustomerList(customers) {
            if (activeCustomersListContainer && customers && customers.length > 0) {
                let customersHtml = '<div class="customer-list">';
                
                customers.forEach(function(customer) {
                    customersHtml += `
                        <div class="customer-item">
                            <div class="customer-name">${customer.first_name || ''} ${customer.last_name || ''}</div>
                            <div class="customer-agency">${customer.agency_name || 'Keine Agentur'}</div>
                            <div class="customer-since">Kunde seit: <span>${formatDate(customer.bill_start) || 'unbekannt'}</span></div>
                        </div>
                    `;
                });
                
                customersHtml += '</div>';
                activeCustomersListContainer.innerHTML = customersHtml;
                console.log('Kundenliste aktualisiert mit', customers.length, 'Kunden');
            } else if (activeCustomersListContainer) {
                activeCustomersListContainer.innerHTML = '<div class="no-data">Keine aktiven Kunden gefunden</div>';
            }
        }
    })();
</script>
