<div class="business-content">
    <div class="business-header">
        <h2>My Business</h2>
    </div>

    <div class="business-tabs">
        <button class="business-tab active" data-tab="overview">Übersicht</button>
        <button class="business-tab" data-tab="kpi">Meine KPIs</button>
        <button class="business-tab" data-tab="customers">Meine Kunden</button>
    </div>

    <div id="overview-tab" class="tab-content active">
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Aktive Kunden (Heute)</div>
                <div class="widget-content" id="active-customers-now-widget">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Daten werden geladen...</div>
                    </div>
                </div> 
            </div>
            
            <div class="widget">
                <div class="widget-header">Abschlussquote (letzte 30 Tage)</div>
                <div class="widget-content" id="conversion-rate-widget">
                    <div class="customer-count">0%</div>
                </div>
            </div>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Umsatz</div>
                <div class="widget-content">
                    <div class="customer-count" id="total-revenue">0 €</div>
                    <div class="month-selector">
                        <select id="month-select" class="month-select">
                            <option value="0">Aktueller Monat</option>
                            <option value="1">Letzter Monat</option>
                            <option value="2">Vor 2 Monaten</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-header">Neue Verträge (letzte 14 Tage)</div>
                <div class="widget-content" id="new-contracts-widget">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Daten werden geladen...</div>
                    </div>
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="new-contracts">0</div>
                            <div class="metric-label">Neu</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="agency-switches">0</div>
                            <div class="metric-label">Agenturwechsel</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Neue Verträge (noch aktiv)</div>
                <div class="widget-content" id="active-contracts-widget">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Daten werden geladen...</div>
                    </div>
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="active-new-contracts">0</div>
                            <div class="metric-label">Neu</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="active-agency-switches">0</div>
                            <div class="metric-label">Agenturwechsel</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-header">Kündigungen</div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="serious-terminations">0</div>
                            <div class="metric-label">Ernst</div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="agency-change-terminations">0</div>
                            <div class="metric-label">Agenturwechsel</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="kpi-tab" class="tab-content">
        

        <!-- NEU: Datumsauswahl für KPIs -->
        <div class="date-range-selector" style="margin-bottom: 15px; border-bottom: 1px solid rgba(0, 255, 255, 0.1); padding-bottom: 15px;">
            <label for="kpi-start-date" style="margin-right: 5px; color: #e0e0e0;">Von:</label>
            <input type="date" class="date-input" id="kpi-start-date">
            <label for="kpi-end-date" style="margin-left: 15px; margin-right: 5px; color: #e0e0e0;">Bis:</label>
            <input type="date" class="date-input" id="kpi-end-date">
            <button class="date-range-button" id="update-kpi-range-btn" style="margin-left: 15px;">Aktualisieren</button>
        </div>
        
        <!-- Erste Zeile: Lead zu EB und Abschlussquote -->
        <div class="widget-row">
            <!-- LINKS: Lead zu EB Conversion -->
            <div class="widget">
                <div class="widget-header">Lead zu EB Conversion</div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="lead-eb-percent">0%</div>
                            <div class="metric-header">
                                <span class="info-icon">i
                                    <span class="tooltip">Prozentualer Anteil der Erfassungsbögen (EB) im Verhältnis zu Leads.</span>
                                </span>
                            </div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="lead-eb-absolute">0/0</div>
                            <div class="metric-header">
                                <span class="info-icon">i
                                    <span class="tooltip">Verhältnis von Erfassungsbögen (EB) zu Leads (absolute Zahlen).</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- RECHTS: Abschlussquote -->
            <div class="widget">
                <div class="widget-header">Abschlussquote (Zeitraum)</div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="closing-rate-percent">0%</div>
                            <div class="metric-header">
                                <span class="info-icon">i
                                    <span class="tooltip">Prozentualer Anteil der Neuverträge im Verhältnis zu Netto-Leads. Berücksichtigt nur echte Neuverträge (ohne Agenturwechsel).</span>
                                </span>
                            </div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="closing-rate-absolute">0 / 0</div>
                            <div class="metric-header">
                                <span class="info-icon">i
                                    <span class="tooltip">Verhältnis von Neuverträgen zu Netto-Leads. Berücksichtigt nur echte Neuverträge (ohne Agenturwechsel).</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Zweite Zeile: EB zu Posting und Lead-Qualität -->
        <div class="widget-row">
            <!-- LINKS: EB zu Posting Conversion -->
            <div class="widget">
                <div class="widget-header">EB zu Posting Conversion</div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="eb-posting-percent">0%</div>
                            <div class="metric-header">
                                <span class="info-icon">i
                                    <span class="tooltip">Prozentualer Anteil der Postings im Verhältnis zu Erfassungsbögen (EB).</span>
                                </span>
                            </div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="eb-posting-absolute">0/0</div>
                            <div class="metric-header">
                                <span class="info-icon">i
                                    <span class="tooltip">Verhältnis von Postings zu Erfassungsbögen (EB) (absolute Zahlen).</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- RECHTS: Lead-Qualität Widget -->
            <div class="widget">
                <div class="widget-header">Lead-Qualität (Zeitraum)</div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="lead-quality-percent">0%</div>
                            <div class="metric-header">
                                <span class="info-icon">i
                                    <span class="tooltip">Prozentualer Anteil erfolgreicher Leads im Verhältnis zu gekauften Leads. Berücksichtigt nur echte Neuverträge (ohne Agenturwechsel).</span>
                                </span>
                            </div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="lead-quality-absolute">0 / 0</div>
                            <div class="metric-header">
                                <span class="info-icon">i
                                    <span class="tooltip">Verhältnis von erfolgreichen Leads zu gekauften Leads. Verträge aus Leads, die im gewählten Zeitraum erworben wurden. Nur echte Neuverträge (ohne Agenturwechsel).</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dritte Zeile: Posting zu Vertrag und Kündigungsquote -->
        <div class="widget-row">
            <!-- LINKS: Posting zu Vertrag Conversion -->
            <div class="widget">
                <div class="widget-header">Posting zu Vertrag Conversion</div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="posting-contract-percent">0%</div>
                            <div class="metric-header">
                                <span class="info-icon">i
                                    <span class="tooltip">Prozentualer Anteil neuer Verträge im Verhältnis zu Postings (ohne Agenturwechsel).</span>
                                </span>
                            </div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="posting-contract-absolute">0/0</div>
                            <div class="metric-header">
                                <span class="info-icon">i
                                    <span class="tooltip">Verhältnis von neuen Verträgen zu Postings (absolute Zahlen, ohne Agenturwechsel).</span>
                                </span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            
            <!-- RECHTS: Kündigungsquote -->
            <div class="widget">
                <div class="widget-header">Kündigungsquote</div>
                <div class="widget-content">
                    <div class="dual-metric large">
                        <div class="dual-metric-item">
                            <div class="metric-value" id="termination-rate-percent">0%</div>
                            <div class="metric-header">
                                <span class="info-icon">i
                                    <span class="tooltip">Prozentualer Anteil der Kündigungen im Verhältnis zu aktiven Kunden.</span>
                                </span>
                            </div>
                        </div>
                        <div class="dual-metric-item">
                            <div class="metric-value" id="termination-rate-absolute">0/0</div>
                            <div class="metric-header">
                                <span class="info-icon">i
                                    <span class="tooltip">Verhältnis von Kündigungen zu aktiven Kunden (absolute Zahlen).</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="customers-tab" class="tab-content">
        <div class="widget-row">
            <div class="wide-widget">
                <div class="widget-header">Aktive Kunden</div>
                <div class="widget-content">
                    <div id="active-customers-list-container">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <div>Kundendaten werden geladen...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Neue Kunden (14 Tage)</div>
                <div class="widget-content" id="new-customers-container">
                    <div class="customer-count">0</div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-header">Kunden in Pause</div>
                <div class="widget-content" id="paused-customers-container">
                    <div class="customer-count">0</div>
                </div>
            </div>
        </div>
        
        <div class="widget-row">
            <div class="widget">
                <div class="widget-header">Am längsten dabei</div>
                <div class="widget-content" id="longest-customers-container">
                    <div class="customer-count">0</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Inline-JavaScript direkt im Overlay -->
<script>
    (function() {
        console.log('My Business Overlay: JavaScript wird initialisiert');
        
        // Element-Referenzen
        const activeCustomersNowWidget = document.getElementById('active-customers-now-widget');
        const activeCustomersListContainer = document.getElementById('active-customers-list-container');
        
        console.log('Active Customers Widget gefunden:', activeCustomersNowWidget !== null);
        console.log('Active Customers List Container gefunden:', activeCustomersListContainer !== null);
        
        // Sofort Daten laden, wenn das Overlay geöffnet wird
        setTimeout(loadDashboardDataDirectly, 500);
        
        // Funktion zum direkten Laden der Dashboard-Daten
        function loadDashboardDataDirectly() {
            console.log('Direktes Laden der Dashboard-Daten wird gestartet');
            
            // Loading-Status anzeigen
            if (activeCustomersNowWidget) {
                activeCustomersNowWidget.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Direktes Laden...</div>
                    </div>
                `;
            }
            
            if (activeCustomersListContainer) {
                activeCustomersListContainer.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Direktes Laden der Kundendaten...</div>
                    </div>
                `;
            }
            
            // Weitere Widgets mit Ladeanzeige aktualisieren
            document.getElementById('conversion-rate-widget').innerHTML = '<div class="loading-spinner"><div class="spinner"></div><div>Laden...</div></div>';
            setElementText('new-contracts', '...');
            setElementText('agency-switches', '...');
            setElementText('serious-terminations', '...');
            setElementText('agency-change-terminations', '...');
            setElementText('active-new-contracts', '...');
            setElementText('active-agency-switches', '...');
            
            // Direkte XHR-Anfrage
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/get_dashboard_data', true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.setRequestHeader('Cache-Control', 'no-cache, no-store, must-revalidate');
            
            xhr.onreadystatechange = function() {
                if (this.readyState === 4) {
                    console.log('XHR Status:', this.status);
                    console.log('XHR Response Anfang:', this.responseText.substring(0, 100));
                    
                    if (this.status === 200) {
                        try {
                            const data = JSON.parse(this.responseText);
                            console.log('Dashboard-Daten erfolgreich geladen:', data);
                            
                            // Kundenzahl aktualisieren
                            if (activeCustomersNowWidget) {
                                activeCustomersNowWidget.innerHTML = `
                                    <div class="customer-count">${data.count || 0}</div>
                                `;
                                console.log('Kundenzahl aktualisiert:', data.count);
                            }
                            
                            // Kundenliste aktualisieren
                            updateCustomerList(data.data);
                            
                            // Gesamtumsatz Pro Rata (NEUE METHODE)
                            const totalRevenueElementNew = document.getElementById('total-revenue');
                            if (totalRevenueElementNew && data.pro_rata_revenue !== undefined) {
                                const proRataRevenue = parseFloat(data.pro_rata_revenue) || 0;
                                totalRevenueElementNew.textContent = `${proRataRevenue.toFixed(2)} €`;
                                console.log('Gesamtumsatz aktualisiert (Pro Rata Methode):', proRataRevenue.toFixed(2));
                            } else if (totalRevenueElementNew) {
                                // Fallback, falls Wert nicht vorhanden
                                totalRevenueElementNew.textContent = '0.00 €';
                                console.log('Gesamtumsatz Pro Rata konnte nicht geladen werden');
                            }
                            
                            // Abschlussquote aktualisieren
                            const conversionRateWidget = document.getElementById('conversion-rate-widget');
                            if (conversionRateWidget && data.conversion_rate) {
                                const rate = data.conversion_rate.conversion_rate || 0;
                                conversionRateWidget.innerHTML = `<div class="customer-count">${rate}%</div>`;
                                console.log('Abschlussquote aktualisiert:', rate);
                            } else if (conversionRateWidget) {
                                conversionRateWidget.innerHTML = `<div class="customer-count">0%</div>`;
                            }
                            
                            // Neue Verträge aktualisieren
                            if (data.new_contracts) {
                                // Spinner entfernen
                                hideLoadingSpinner('new-contracts-widget');
                                
                                // Echte neue Verträge
                                const newContractsCount = data.new_contracts.normal_contracts_count || 0;
                                setElementText('new-contracts', newContractsCount);
                                
                                                // Agenturwechsel
                                const agencyChangesCount = data.new_contracts.agency_change_contracts_count || 0;
                                setElementText('agency-switches', agencyChangesCount);
                                
                                console.log('Neue Verträge aktualisiert:', newContractsCount, 'neu,', agencyChangesCount, 'Agenturwechsel');
                                
                                // Lade Kunden in Pause
                                loadPausedCustomers();
                            }
                            
                            // Aktive neue Verträge aktualisieren
                            if (data.active_new_contracts || data.new_contracts) {
                                const activeData = data.active_new_contracts ? data.active_new_contracts : data.new_contracts;
                                // Spinner entfernen
                                hideLoadingSpinner('active-contracts-widget');
                                
                                // Echte neue Verträge
                                const activeNewContractsCount = activeData.normal_contracts_count || 0;
                                setElementText('active-new-contracts', activeNewContractsCount);
                                
                                // Agenturwechsel
                                const activeAgencyChangesCount = activeData.agency_change_contracts_count || 0;
                                setElementText('active-agency-switches', activeAgencyChangesCount);
                                
                                console.log('Aktive neue Verträge aktualisiert:', activeNewContractsCount, 'neu,', activeAgencyChangesCount, 'Agenturwechsel');
                            }
                            
                            // Kündigungen aktualisieren
                            if (data.terminations) {
                                // Ernsthafte Kündigungen
                                const seriousTerminations = data.terminations.serious_terminations_count || 0;
                                setElementText('serious-terminations', seriousTerminations);
                                
                                // Agenturwechsel
                                const agencyChangeTerminations = data.terminations.agency_switch_count || 0;
                                setElementText('agency-change-terminations', agencyChangeTerminations);
                                
                                console.log('Kündigungen aktualisiert:', seriousTerminations, 'ernsthaft,', agencyChangeTerminations, 'Agenturwechsel');
                            }
                            
                        } catch (e) {
                            console.error('Fehler beim Parsen der JSON-Antwort:', e);
                            showErrorMessage('Fehler beim Parsen der Daten: ' + e.message);
                        }
                    } else {
                        console.error('XHR-Fehler:', this.status);
                        showErrorMessage('Server-Fehler: ' + this.status);
                    }
                }
            };
            
            xhr.onerror = function() {
                console.error('Netzwerkfehler bei der XHR-Anfrage');
                showErrorMessage('Netzwerkfehler bei der Anfrage');
            };
            
            xhr.send();
            console.log('XHR-Anfrage gesendet');
        }
        
        // Hilfsfunktion zur Textaktualisierung von Elementen
        function setElementText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            } else {
                console.warn(`Element mit ID ${elementId} nicht gefunden`);
            }
        }
        
        // Hilfsfunktion zum Ausblenden des Loading-Spinners
        function hideLoadingSpinner(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                const spinner = container.querySelector('.loading-spinner');
                if (spinner) {
                    spinner.style.display = 'none';
                }
            } else {
                console.warn(`Container mit ID ${containerId} nicht gefunden`);
            }
        }
        
        // Hilfsfunktion zur Fehleranzeige
        function showErrorMessage(message) {
            const errorHtml = `
                <div class="error-message">
                    <div>Fehler</div>
                    <div class="error-details">${message}</div>
                </div>
            `;
            
            if (activeCustomersNowWidget) {
                activeCustomersNowWidget.innerHTML = errorHtml;
            }
            
            if (activeCustomersListContainer) {
                activeCustomersListContainer.innerHTML = errorHtml;
            }
        }
        
        // Hilfsfunktion zum Formatieren des Datums
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            if (isNaN(date)) return '';
            
            return date.toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        // Funktion zum Laden der Kunden in Pause
        function loadPausedCustomers() {
            console.log('Lade Kunden in Pause...');
            const pausedCustomersContainer = document.getElementById('paused-customers-container');
            
            // Lade-Indikator anzeigen
            if (pausedCustomersContainer) {
                pausedCustomersContainer.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div>Lade Kunden in Pause...</div>
                    </div>
                `;
            }
            
            // API-Anfrage
            fetch('/run_query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    query_name: 'get_customers_on_pause',
                    params: {}
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Netzwerkantwort war nicht ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Kunden in Pause geladen:', data);
                
                if (pausedCustomersContainer) {
                    if (data && data.rows && data.rows.length > 0) {
                        // Nehme den total_paused_customers Wert aus dem ersten Ergebnis
                        const totalPausedCustomers = data.rows[0].total_paused_customers || 0;
                        
                        // Zeige die Gesamtzahl an
                        pausedCustomersContainer.innerHTML = `<div class="customer-count">${totalPausedCustomers}</div>`;
                        
                        // Detaillierte Informationen in der Konsole ausgeben
                        console.log(`${totalPausedCustomers} Kunden sind in Pause`);
                        
                        // Liste der ersten 10 Kunden in Pause ausgeben (für Debug-Zwecke)
                        if (data.rows.length > 0) {
                            console.log('Beispiele für Kunden in Pause:');
                            data.rows.slice(0, 10).forEach((customer, index) => {
                                console.log(`${index + 1}. ${customer.first_name} ${customer.last_name}, in Pause seit ${customer.days_on_pause} Tagen`);
                            });
                        }
                    } else {
                        pausedCustomersContainer.innerHTML = `<div class="customer-count">0</div>`;
                        console.log('Keine Kunden in Pause gefunden.');
                    }
                }
            })
            .catch(error => {
                console.error('Fehler beim Laden der Kunden in Pause:', error);
                if (pausedCustomersContainer) {
                    pausedCustomersContainer.innerHTML = `<div class="customer-count">-</div>`;
                }
            });
        }
        
        // Funktion zum Aktualisieren der Kundenliste
        function updateCustomerList(customers) {
            if (activeCustomersListContainer && customers && customers.length > 0) {
                let customersHtml = '<div class="customer-list">';
                
                // Map um Kunden nach Namen zu gruppieren und Duplikate zu identifizieren
                const customerMap = new Map();
                
                // Jedes Kundendatenobjekt durchgehen
                customers.forEach(function(customer) {
                    // Eindeutigen Schlüssel für jeden Kunden erstellen
                    const customerKey = `${customer.first_name || ''} ${customer.last_name || ''}`.trim().toLowerCase();
                    
                    // Wenn der Kunde noch nicht in der Map ist, fügen wir ihn hinzu
                    if (!customerMap.has(customerKey)) {
                        customerMap.set(customerKey, {
                            customer: customer,
                            count: 1 // Zähle, wie viele Care Stays dieser Kunde hat
                        });
                    } else {
                        // Wenn der Kunde bereits existiert, erhöhe den Zähler
                        const existingData = customerMap.get(customerKey);
                        existingData.count += 1;
                        customerMap.set(customerKey, existingData);
                    }
                });
                
                // CSS-Styles für das Warndreieck
                const styles = `
                    <style>
                        .warning-triangle {
                            color: #ff4040;
                            margin-left: 5px;
                            font-size: 16px;
                            position: relative;
                            cursor: help;
                        }
                        .warning-triangle:hover::after {
                            content: attr(data-title);
                            position: absolute;
                            background: rgba(0, 0, 0, 0.8);
                            color: white;
                            border-radius: 4px;
                            padding: 5px 10px;
                            font-size: 12px;
                            width: 200px;
                            left: 20px;
                            top: -5px;
                            z-index: 100;
                            font-weight: normal;
                        }
                    </style>
                `;
                customersHtml += styles;
                
                // Erstelle einen Eintrag für jeden eindeutigen Kunden
                customerMap.forEach(function(data) {
                    const customer = data.customer;
                    const careStayCount = data.count;
                    
                    // Warndreieck für mehrere Care Stays hinzufügen
                    const warningIcon = careStayCount > 1 
                        ? `<span class="warning-triangle" data-title="Kunde hat ${careStayCount} aktive Pflegeeinsätze gleichzeitig, wird aber nur einmal gezählt">⚠</span>` 
                        : '';
                    
                    customersHtml += `
                        <div class="customer-item">
                            <div class="customer-name">${customer.first_name || ''} ${customer.last_name || ''} ${warningIcon}</div>
                            <div class="customer-agency">${customer.agency_name || 'Keine Agentur'}</div>
                            <div class="customer-since">${formatDate(customer.bill_start) || 'unbekannt'} - ${formatDate(customer.bill_end) || 'laufend'}</div>
                        </div>
                    `;
                });
                
                customersHtml += '</div>';
                activeCustomersListContainer.innerHTML = customersHtml;
                
                // Zähle die tatsächlichen eindeutigen Kunden
                const uniqueCustomerCount = customerMap.size;
                console.log('Kundenliste aktualisiert mit', uniqueCustomerCount, 'eindeutigen Kunden von insgesamt', customers.length, 'Care Stays');
                
                // Update the customer count to reflect the unique customers
                if (activeCustomersNowWidget) {
                    activeCustomersNowWidget.innerHTML = `<div class="customer-count">${uniqueCustomerCount}</div>`;
                    console.log('Kundenzahl korrigiert auf eindeutige Kunden:', uniqueCustomerCount);
                }
            } else {
                activeCustomersListContainer.innerHTML = '<div class="empty-message">Keine aktiven Kunden gefunden</div>';
            }
        }
    })();
</script>
